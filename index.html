<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lesson Navi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#334155', // slate-700
              'primary-dark': '#1e293b', // slate-800
              secondary: '#f1f5f9', // slate-100
              accent: '#6366f1', // indigo-500
              'accent-dark': '#4f46e5', // indigo-600
            },
          },
        },
      }
    </script>
    <!-- Import Map for bare module specifiers -->
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
        }
      }
    </script>
    <!-- Add Babel Standalone for in-browser JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-secondary">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      import React, { useState, useMemo, useEffect, useCallback, createContext, useContext } from 'react';
      import { createRoot } from 'react-dom/client';
      import { 
        Calendar, Users, ClipboardList, LayoutDashboard, 
        DollarSign, Ticket, Clock, AlertTriangle,
        PlusCircle, Edit, History, LogOut,
        Trash2, X, LoaderCircle, Languages, Clipboard
      } from 'https://esm.sh/lucide-react@0.408.0?external=react';
      
      // --- Firebase SDKs ---
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
      import { 
        getAuth, 
        onAuthStateChanged,
        GoogleAuthProvider,
        signInWithPopup,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut
      } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
      import { 
        getFirestore, 
        collection, 
        onSnapshot, 
        addDoc, 
        updateDoc, 
        doc, 
        deleteDoc,
        Timestamp,
        query,
        where
      } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';


      // --- PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE ---
      const firebaseConfig = {
        apiKey: "AIzaSyD556mSEm-Q7IAIykHGXjhWc-kpgcmMpF0",
        authDomain: "ticket-tora.firebaseapp.com",
        projectId: "ticket-tora",
        storageBucket: "ticket-tora.firebasestorage.app",
        messagingSenderId: "194518083030",
        appId: "1:194518083030:web:b4b21f2786275e76deb077"
      };
      
      // --- Initialize Firebase ---
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- Enums and Constants (from types.js) ---
      const ClientStatus = Object.freeze({ ACTIVE: 'active', INACTIVE: 'inactive' });
      const TicketType = Object.freeze({ PRIVATE: 'private', GROUP: 'group' });
      const PackTemplateStatus = Object.freeze({ ACTIVE: 'active', INACTIVE: 'inactive' });
      const PackHistoryType = Object.freeze({ PURCHASE: 'purchase', ATTENDANCE: 'attendance', EXPIRY_CHANGE: 'expiry_change' });
      const Page = Object.freeze({ DASHBOARD: 'dashboard', CLIENTS: 'clients', TEMPLATES: 'templates', ATTENDANCE: 'attendance' });

      // --- i18n Translation Setup ---
      const translations = {
        en: {
            // General
            active: 'Active',
            inactive: 'Inactive',
            group: 'Group',
            private: 'Private',
            save: 'Save',
            cancel: 'Cancel',
            tickets: 'Tickets',
            expires: 'Expires',
            status_expired: 'Expired',
            status_used: 'Used',
            status_active: 'Active',
            // Login
            createAccountPrompt: 'Create an account to get started',
            signInPrompt: 'Sign in to your account',
            emailLabel: 'Email address',
            passwordLabel: 'Password',
            signUpButton: 'Sign Up',
            signInButton: 'Sign In',
            orSeparator: 'OR',
            googleSignInButton: 'Sign in with Google',
            alreadyHaveAccount: 'Already have an account?',
            dontHaveAccount: "Don't have an account?",
            // Nav
            dashboard: 'Dashboard',
            clients: 'Clients',
            packTemplates: 'Pack Settings',
            attendance: 'Attendance',
            signOut: 'Sign Out',
            signOutConfirm: 'Are you sure you want to sign out?',
            // Dashboard
            salesLast30: 'Total Sales (Last 30 Days)',
            ticketsUsedLast30: 'Tickets Used (Last 30 Days)',
            expiringNext30: 'Packs Expiring in Next 30 Days',
            noExpiringPacks: 'No packs expiring soon.',
            lowBalance: 'Critical Low Balance (1 Ticket Left)',
            noLowBalanceClients: 'No clients with a critically low balance.',
            // Clients
            addClient: 'Add Client',
            backToClientList: '← Back to Client List',
            recordPurchase: 'Record Purchase',
            purchasedPacks: 'Purchased Packs',
            ticketsRemaining: 'Tickets Remaining',
            viewHistory: 'View History',
            pauseEditExpiry: 'Pause/Edit Expiry',
            noPacksPurchased: 'No packs purchased yet.',
            editClient: 'Edit Client',
            addNewClient: 'Add New Client',
            firstName: 'First Name',
            lastName: 'Last Name',
            email: 'Email',
            phone: 'Phone',
            setToInactive: 'Set to Inactive',
            setToActive: 'Set to Active',
            saveClient: 'Save Client',
            recordPurchaseFor: 'Record Purchase for {clientName}',
            ticketPack: 'Ticket Pack',
            selectAPack: 'Select a pack',
            purchaseDate: 'Purchase Date',
            copyHistory: 'Copy for Chat',
            copied: 'Copied!',
            packHistorySummaryTitle: "Pack Summary for {packName}",
            packHistorySummaryPurchase: "Purchased on: {date} for {price}",
            packHistorySummaryExpiry: "Expires on: {date}",
            packHistorySummaryTickets: "Tickets: {remaining}/{initial}",
            packHistorySummaryAttendanceHeader: "Attendance:",
            packHistorySummaryNoAttendance: "No classes attended yet.",
            // Templates
            addTemplate: 'Add Pack',
            templateDetails: '{count} {type} tickets for {price} (Expires in {months} months)',
            deactivate: 'Deactivate',
            activate: 'Activate',
            editTemplate: 'Edit Template',
            addNewTemplate: 'Add New Template',
            packName: 'Pack Name',
            numTickets: 'Number of Tickets',
            ticketType: 'Ticket Type',
            price: 'Price',
            expiryMonths: 'Expiry (Months)',
            saveTemplate: 'Save Template',
            // Attendance
            recordAttendance: 'Record Attendance',
            classDate: 'Class Date',
            classType: 'Class Type',
            attendees: 'Attendees',
            searchAttendees: 'Search for attendees...',
            noMatchingClients: 'No matching eligible clients found.',
            recordAttendanceCount: 'Record Attendance ({count})',
            attendanceHistory: 'Attendance History',
            historyDate: 'Date',
            historyClient: 'Client',
            historyClassType: 'Class Type',
            historyActions: 'Actions',
            noAttendanceRecords: 'No attendance records found.',
            deleteAttendanceConfirm: 'Are you sure you want to delete this attendance record? This will restore the ticket to the client.',
            purchaseHistoryDetails: 'Purchased pack for {price}',
            attendanceHistoryDetails: 'Attended {classType} class',
            expiryChangeHistoryDetails: 'Expiry date changed from {oldDate} to {newDate}',
        },
        ja: {
            // General
            active: '有効',
            inactive: '無効',
            group: 'グループ',
            private: 'プライベート',
            save: '保存',
            cancel: 'キャンセル',
            tickets: 'チケット',
            expires: '有効期限',
            status_expired: '期限切れ',
            status_used: '使用済み',
            status_active: '有効',
            // Login
            createAccountPrompt: 'アカウントを作成して始めましょう',
            signInPrompt: 'アカウントにサインイン',
            emailLabel: 'メールアドレス',
            passwordLabel: 'パスワード',
            signUpButton: '会員登録',
            signInButton: 'サインイン',
            orSeparator: 'または',
            googleSignInButton: 'Googleでサインイン',
            alreadyHaveAccount: 'すでにアカウントをお持ちですか？',
            dontHaveAccount: 'アカウントをお持ちでないですか？',
            // Nav
            dashboard: 'ダッシュボード',
            clients: '顧客一覧',
            packTemplates: 'チケット設定',
            attendance: '出席',
            signOut: 'サインアウト',
            signOutConfirm: '本当にサインアウトしますか？',
            // Dashboard
            salesLast30: '売上 (過去30日間)',
            ticketsUsedLast30: '使用済みチケット (過去30日間)',
            expiringNext30: '今後30日以内に期限切れのパック',
            noExpiringPacks: 'まもなく期限切れになるパックはありません。',
            lowBalance: '残高不足 (残り1チケット)',
            noLowBalanceClients: '残高不足のクライアントはいません。',
            // Clients
            addClient: 'クライアントを追加',
            backToClientList: '← 顧客一覧に戻る',
            recordPurchase: '購入を記録',
            purchasedPacks: '購入済みパック',
            ticketsRemaining: '残りチケット',
            viewHistory: '履歴を表示',
            pauseEditExpiry: '有効期限を一時停止/編集',
            noPacksPurchased: 'まだパックは購入されていません。',
            editClient: 'クライアントを編集',
            addNewClient: '新規クライアントを追加',
            firstName: '名',
            lastName: '姓',
            email: 'メール',
            phone: '電話番号',
            setToInactive: '無効にする',
            setToActive: '有効にする',
            saveClient: 'クライアントを保存',
            recordPurchaseFor: '{clientName} の購入を記録',
            ticketPack: 'チケットパック',
            selectAPack: 'パックを選択',
            purchaseDate: '購入日',
            copyHistory: 'チャット用にコピー',
            copied: 'コピーしました！',
            packHistorySummaryTitle: "{packName}のパック概要",
            packHistorySummaryPurchase: "購入日: {date} ({price})",
            packHistorySummaryExpiry: "有効期限: {date}",
            packHistorySummaryTickets: "チケット: {remaining}/{initial} 枚",
            packHistorySummaryAttendanceHeader: "出席履歴:",
            packHistorySummaryNoAttendance: "まだ出席したクラスはありません。",
            // Templates
            addTemplate: 'パックを追加',
            templateDetails: '{count}枚の{type}チケット、{price}（{months}ヶ月間有効）',
            deactivate: '無効化',
            activate: '有効化',
            editTemplate: 'テンプレートを編集',
            addNewTemplate: '新規テンプレートを追加',
            packName: 'パック名',
            numTickets: 'チケット数',
            ticketType: 'チケットタイプ',
            price: '価格',
            expiryMonths: '有効期限（月）',
            saveTemplate: 'テンプレートを保存',
            // Attendance
            recordAttendance: '出席を記録',
            classDate: 'クラス日',
            classType: 'クラスタイプ',
            attendees: '出席者',
            searchAttendees: '出席者を検索...',
            noMatchingClients: '該当するクライアントが見つかりません。',
            recordAttendanceCount: '出席を記録 ({count})',
            attendanceHistory: '出席履歴',
            historyDate: '日付',
            historyClient: 'クライアント',
            historyClassType: 'クラスタイプ',
            historyActions: 'アクション',
            noAttendanceRecords: '出席記録はありません。',
            deleteAttendanceConfirm: 'この出席記録を本当に削除しますか？これにより、クライアントにチケットが戻されます。',
            purchaseHistoryDetails: 'パックを{price}で購入しました',
            attendanceHistoryDetails: '{classType}クラスに出席しました',
            expiryChangeHistoryDetails: '有効期限が{oldDate}から{newDate}に変更されました',
        },
      };
      
      const LanguageContext = createContext();

      const LanguageProvider = ({ children }) => {
        const [language, setLanguage] = useState(localStorage.getItem('language') || 'en');

        useEffect(() => {
          localStorage.setItem('language', language);
          document.documentElement.lang = language;
        }, [language]);

        const t = (key, options = {}) => {
            let translation = translations[language][key] || translations['en'][key] || key;
            Object.keys(options).forEach(optionKey => {
                translation = translation.replace(`{${optionKey}}`, options[optionKey]);
            });
            return translation;
        };

        const formatCurrency = (amount) => {
          const locale = language === 'ja' ? 'ja-JP' : 'en-US';
          const currency = language === 'ja' ? 'JPY' : 'USD';
          return new Intl.NumberFormat(locale, { style: 'currency', currency }).format(amount);
        };

        const formatDate = (dateString) => {
            const locale = language === 'ja' ? 'ja-JP' : 'en-US';
            return new Date(dateString).toLocaleDateString(locale);
        };
        
        return (
            <LanguageContext.Provider value={{ language, setLanguage, t, formatCurrency, formatDate }}>
                {children}
            </LanguageContext.Provider>
        );
      };

      const useLanguage = () => useContext(LanguageContext);

      const LanguageSwitcher = ({ className }) => {
        const { language, setLanguage } = useLanguage();
        
        return (
            <div className={`relative ${className}`}>
                <select 
                    value={language} 
                    onChange={e => setLanguage(e.target.value)}
                    className="appearance-none bg-transparent border border-slate-300 rounded-md py-2 pl-3 pr-8 text-sm font-medium text-slate-700 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-accent"
                    aria-label="Language switcher"
                >
                    <option value="en">English</option>
                    <option value="ja">日本語</option>
                </select>
                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-700">
                    <svg className="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="http://www.w3.org/2000/svg"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
            </div>
        );
      };

      // --- Data Hook (Re-written for Firebase) ---
      const useFirestoreData = (userId) => {
          const { t, formatCurrency, formatDate } = useLanguage();
          const [clients, setClients] = useState([]);
          const [packTemplates, setPackTemplates] = useState([]);
          const [purchasedPacks, setPurchasedPacks] = useState([]);
          const [attendanceRecords, setAttendanceRecords] = useState([]);
          const [loading, setLoading] = useState(true);

          useEffect(() => {
              if (!userId) {
                  setLoading(false);
                  return;
              };

              const collections = {
                  clients: collection(db, 'users', userId, 'clients'),
                  packTemplates: collection(db, 'users', userId, 'packTemplates'),
                  purchasedPacks: collection(db, 'users', userId, 'purchasedPacks'),
                  attendanceRecords: collection(db, 'users', userId, 'attendanceRecords'),
              };

              const unsubscribes = [
                  onSnapshot(collections.clients, snapshot => {
                      setClients(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                  }),
                  onSnapshot(collections.packTemplates, snapshot => {
                      setPackTemplates(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                  }),
                  onSnapshot(collections.purchasedPacks, snapshot => {
                      setPurchasedPacks(snapshot.docs.map(doc => {
                          const data = doc.data();
                          // Convert Firestore Timestamps back to JS Dates
                          return {
                              id: doc.id,
                              ...data,
                              purchaseDate: data.purchaseDate?.toDate().toISOString(),
                              expiryDate: data.expiryDate?.toDate().toISOString(),
                              history: data.history.map(h => ({...h, date: h.date?.toDate().toISOString()}))
                          };
                      }));
                  }),
                  onSnapshot(collections.attendanceRecords, snapshot => {
                      setAttendanceRecords(snapshot.docs.map(doc => {
                           const data = doc.data();
                           return { id: doc.id, ...data, classDate: data.classDate?.toDate().toISOString() };
                      }));
                  }),
              ];
              
              setLoading(false); // Consider more granular loading later

              // Cleanup listeners on unmount
              return () => unsubscribes.forEach(unsub => unsub());
          }, [userId]);

          // --- Data Modification Functions (now write to Firestore) ---

          const addClient = (client) => addDoc(collection(db, 'users', userId, 'clients'), client);
          const updateClient = (updatedClient) => {
              const { id, ...data } = updatedClient;
              updateDoc(doc(db, 'users', userId, 'clients', id), data);
          };

          const addPackTemplate = (template) => addDoc(collection(db, 'users', userId, 'packTemplates'), template);
          
          const updatePackTemplate = async (updatedTemplate) => {
              if (updatedTemplate.status === PackTemplateStatus.INACTIVE) {
                  const hasActivePacks = purchasedPacks.some(p => 
                      p.templateId === updatedTemplate.id &&
                      p.ticketsRemaining > 0 &&
                      new Date(p.expiryDate) > new Date()
                  );

                  if (hasActivePacks) {
                      alert('Cannot make template inactive as there are active client packs using it.');
                      return;
                  }
              }
              const { id, ...data } = updatedTemplate;
              updateDoc(doc(db, 'users', userId, 'packTemplates', id), data);
          };
          
          const recordPurchase = async (clientId, templateId, purchaseDate) => {
              const template = packTemplates.find(t => t.id === templateId);
              if (!template) {
                  throw new Error('Error: Selected pack template could not be found.');
              }

              const expiryDate = new Date(purchaseDate);
              expiryDate.setMonth(expiryDate.getMonth() + template.expiryMonths);
              
              const details = t('purchaseHistoryDetails', { price: formatCurrency(template.price) });

              const newPack = {
                  clientId,
                  templateId,
                  purchaseDate: Timestamp.fromDate(purchaseDate),
                  expiryDate: Timestamp.fromDate(expiryDate),
                  initialTickets: template.ticketCount,
                  ticketsRemaining: template.ticketCount,
                  purchasePrice: template.price,
                  history: [
                      { date: Timestamp.fromDate(purchaseDate), type: PackHistoryType.PURCHASE, details }
                  ]
              };

              try {
                  await addDoc(collection(db, 'users', userId, 'purchasedPacks'), newPack);
              } catch (error) {
                  console.error("Error recording purchase in Firestore: ", error);
                  throw new Error(`Failed to record purchase. Please check your network connection and try again.`);
              }
          };

          const updatePurchasedPackExpiry = (packId, newExpiryDate) => {
              const packRef = doc(db, 'users', userId, 'purchasedPacks', packId);
              const pack = purchasedPacks.find(p => p.id === packId);
              if(!pack) return;

              const oldExpiryDate = formatDate(pack.expiryDate);
              const details = t('expiryChangeHistoryDetails', {
                  oldDate: oldExpiryDate,
                  newDate: formatDate(newExpiryDate.toISOString()),
              });

              const updatedHistory = {
                  date: Timestamp.now(),
                  type: PackHistoryType.EXPIRY_CHANGE,
                  details,
              };

              updateDoc(packRef, {
                  expiryDate: Timestamp.fromDate(newExpiryDate),
                  history: [...pack.history.map(h => ({...h, date: Timestamp.fromDate(new Date(h.date))})), updatedHistory]
              });
          };

          const recordAttendance = useCallback((classDate, classType, clientIds) => {
              clientIds.forEach(clientId => {
                  const clientPacks = purchasedPacks
                      .filter(p => {
                          const template = packTemplates.find(t => t.id === p.templateId);
                          return p.clientId === clientId &&
                                template?.ticketType === classType &&
                                p.ticketsRemaining > 0 &&
                                new Date(p.expiryDate) >= classDate;
                      })
                      .sort((a, b) => new Date(a.expiryDate).getTime() - new Date(b.expiryDate).getTime());

                  if (clientPacks.length > 0) {
                      const packToDeduct = clientPacks[0];
                      const packRef = doc(db, 'users', userId, 'purchasedPacks', packToDeduct.id);
                      
                      updateDoc(packRef, {
                          ticketsRemaining: packToDeduct.ticketsRemaining - 1,
                          history: [
                              ...packToDeduct.history.map(h => ({...h, date: Timestamp.fromDate(new Date(h.date))})),
                              {
                                date: Timestamp.fromDate(classDate),
                                type: PackHistoryType.ATTENDANCE,
                                details: t('attendanceHistoryDetails', { classType: t(classType) })
                              }
                          ]
                      });
                      
                      addDoc(collection(db, 'users', userId, 'attendanceRecords'), {
                          classDate: Timestamp.fromDate(classDate),
                          classType,
                          clientId,
                          purchasedPackId: packToDeduct.id
                      });
                  }
              });
          }, [purchasedPacks, packTemplates, userId, t]);

          const deleteAttendance = useCallback(async (recordId) => {
              const recordToDelete = attendanceRecords.find(r => r.id === recordId);
              if (!recordToDelete) return;

              const packRef = doc(db, 'users', userId, 'purchasedPacks', recordToDelete.purchasedPackId);
              const pack = purchasedPacks.find(p => p.id === recordToDelete.purchasedPackId);

              if (pack) {
                  await updateDoc(packRef, {
                      ticketsRemaining: pack.ticketsRemaining + 1,
                      history: pack.history
                        .map(h => ({...h, date: Timestamp.fromDate(new Date(h.date))}))
                        .filter(h => h.type !== PackHistoryType.ATTENDANCE || h.date.toMillis() !== new Date(recordToDelete.classDate).getTime())
                  });
              }

              await deleteDoc(doc(db, 'users', userId, 'attendanceRecords', recordId));
          }, [attendanceRecords, purchasedPacks, userId]);
          
          return {
              loading,
              clients, addClient, updateClient,
              packTemplates, addPackTemplate, updatePackTemplate,
              purchasedPacks, recordPurchase, updatePurchasedPackExpiry,
              attendanceRecords, recordAttendance, deleteAttendance
          };
      };

      // --- Screens (largely unchanged, but now get data from Firestore hook) ---
      const StatCard = ({ icon, title, value, iconBg, iconColor }) => (
          <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200/80 flex items-center">
              <div className={`rounded-full p-3 mr-4 ${iconBg} ${iconColor}`}>
                  {icon}
              </div>
              <div>
                  <p className="text-sm text-slate-500 font-medium">{title}</p>
                  <p className="text-2xl font-bold text-primary-dark">{value}</p>
              </div>
          </div>
      );

      const DashboardScreen = ({ data }) => {
          const { t, formatCurrency, formatDate } = useLanguage();
          const { clients, purchasedPacks, attendanceRecords, packTemplates } = data;

          const stats = useMemo(() => {
              const thirtyDaysAgo = new Date();
              thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

              const totalSales = purchasedPacks
                  .filter(p => new Date(p.purchaseDate) >= thirtyDaysAgo)
                  .reduce((sum, p) => sum + p.purchasePrice, 0);

              const totalTicketsUsed = attendanceRecords
                  .filter(a => new Date(a.classDate) >= thirtyDaysAgo)
                  .length;

              return { totalSales, totalTicketsUsed };
          }, [purchasedPacks, attendanceRecords]);

          const expiringPacks = useMemo(() => {
              const thirtyDaysFromNow = new Date();
              thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
              const today = new Date();

              return purchasedPacks
                  .filter(p => {
                      const expiryDate = new Date(p.expiryDate);
                      return expiryDate >= today && expiryDate <= thirtyDaysFromNow && p.ticketsRemaining > 0;
                  })
                  .sort((a, b) => new Date(a.expiryDate).getTime() - new Date(b.expiryDate).getTime())
                  .map(p => {
                      const client = clients.find(c => c.id === p.clientId);
                      const template = packTemplates.find(t => t.id === p.templateId);
                      return { ...p, client, template };
                  });
          }, [purchasedPacks, clients, packTemplates]);
          
          const lowBalanceClients = useMemo(() => {
              const today = new Date();
              return purchasedPacks
                  .filter(p => p.ticketsRemaining === 1 && new Date(p.expiryDate) >= today)
                  .map(p => {
                      const client = clients.find(c => c.id === p.clientId);
                      const template = packTemplates.find(t => t.id === p.templateId);
                      return { ...p, client, template };
                  });
          }, [purchasedPacks, clients, packTemplates]);

          return (
              <div className="space-y-8">
                  <h2 className="text-3xl font-bold text-primary-dark">{t('dashboard')}</h2>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <StatCard 
                          icon={<DollarSign className="h-6 w-6"/>} 
                          title={t('salesLast30')} 
                          value={formatCurrency(stats.totalSales)}
                          iconBg="bg-emerald-100"
                          iconColor="text-emerald-600"
                      />
                      <StatCard 
                          icon={<Ticket className="h-6 w-6"/>} 
                          title={t('ticketsUsedLast30')} 
                          value={stats.totalTicketsUsed}
                          iconBg="bg-sky-100"
                          iconColor="text-sky-600"
                      />
                  </div>

                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200/80">
                          <h3 className="text-xl font-semibold text-primary-dark mb-4 flex items-center">
                              <Clock className="h-6 w-6 mr-3 text-accent" />
                              {t('expiringNext30')}
                          </h3>
                          <div className="space-y-0 max-h-96 overflow-y-auto">
                              {expiringPacks.length > 0 ? expiringPacks.map((p, index) => (
                                  <div key={p.id} className={`p-4 border-b border-slate-200 ${index === expiringPacks.length - 1 ? 'border-b-0' : ''}`}>
                                      <p className="font-semibold text-primary-dark">{p.client?.firstName} {p.client?.lastName}</p>
                                      <p className="text-sm text-slate-500">{p.template?.name}</p>
                                      <div className="flex justify-between items-baseline text-sm mt-1">
                                          <span className="font-medium text-slate-600">{t('tickets')}: {p.ticketsRemaining}</span>
                                          <span className="font-semibold text-amber-700">{t('expires')}: {formatDate(p.expiryDate)}</span>
                                      </div>
                                  </div>
                              )) : <p className="text-slate-500 p-4">{t('noExpiringPacks')}</p>}
                          </div>
                      </div>

                      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200/80">
                          <h3 className="text-xl font-semibold text-primary-dark mb-4 flex items-center">
                              <AlertTriangle className="h-6 w-6 mr-3 text-yellow-500" />
                              {t('lowBalance')}
                          </h3>
                          <div className="space-y-0 max-h-96 overflow-y-auto">
                              {lowBalanceClients.length > 0 ? lowBalanceClients.map((p, index) => (
                                  <div key={p.id} className={`p-4 border-b border-slate-200 ${index === lowBalanceClients.length - 1 ? 'border-b-0' : ''}`}>
                                      <p className="font-semibold text-primary-dark">{p.client?.firstName} {p.client?.lastName}</p>
                                      <p className="text-sm text-slate-500">{p.template?.name}</p>
                                  </div>
                              )) : <p className="text-slate-500 p-4">{t('noLowBalanceClients')}</p>}
                          </div>
                      </div>
                  </div>
              </div>
          );
      };

      const ClientFormModal = ({ client, onSave, onClose, onToggleStatus }) => {
          const { t } = useLanguage();
          const [formData, setFormData] = useState({
              firstName: client?.firstName || '',
              lastName: client?.lastName || '',
              email: client?.email || '',
              phone: client?.phone || '',
          });

          const handleChange = (e) => {
              const { name, value } = e.target;
              setFormData(prev => ({ ...prev, [name]: value }));
          };

          const handleSubmit = (e) => {
              e.preventDefault();
              if (client) {
                onSave({ ...client, ...formData });
              } else {
                onSave({ ...formData, status: ClientStatus.ACTIVE });
              }
          };
          
          return (
              <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-xl shadow-xl p-8 w-full max-w-md">
                      <h2 className="text-2xl font-bold mb-6 text-primary-dark">{client ? t('editClient') : t('addNewClient')}</h2>
                      <form onSubmit={handleSubmit} className="space-y-4">
                          <div>
                              <label htmlFor="firstName" className="block text-sm font-medium text-slate-700">{t('firstName')}</label>
                              <input type="text" name="firstName" value={formData.firstName} onChange={handleChange} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                          </div>
                          <div>
                              <label htmlFor="lastName" className="block text-sm font-medium text-slate-700">{t('lastName')}</label>
                              <input type="text" name="lastName" value={formData.lastName} onChange={handleChange} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                          </div>
                          <div>
                              <label htmlFor="email" className="block text-sm font-medium text-slate-700">{t('email')}</label>
                              <input type="email" name="email" value={formData.email} onChange={handleChange} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                          </div>
                          <div>
                              <label htmlFor="phone" className="block text-sm font-medium text-slate-700">{t('phone')}</label>
                              <input type="tel" name="phone" value={formData.phone} onChange={handleChange} className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                          </div>
                          <div className="flex justify-between items-center pt-6">
                              <div>
                                  {client && (
                                      <button 
                                          type="button" 
                                          onClick={() => {
                                              onToggleStatus(client);
                                              onClose();
                                          }}
                                          className={`px-4 py-2 text-sm font-medium rounded-md transition-colors ${
                                              client.status === ClientStatus.ACTIVE
                                                  ? 'bg-rose-100 text-rose-800 hover:bg-rose-200'
                                                  : 'bg-emerald-100 text-emerald-800 hover:bg-emerald-200'
                                          }`}
                                      >
                                          {client.status === ClientStatus.ACTIVE ? t('setToInactive') : t('setToActive')}
                                      </button>
                                  )}
                              </div>
                              <div className="flex justify-end space-x-4">
                                  <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 font-semibold">{t('cancel')}</button>
                                  <button type="submit" className="px-4 py-2 bg-accent text-white rounded-md hover:bg-accent-dark font-semibold">{t('saveClient')}</button>
                              </div>
                          </div>
                      </form>
                  </div>
              </div>
          );
      };

      const PurchaseModal = ({ client, templates, onSave, onClose }) => {
          const { t } = useLanguage();
          const [templateId, setTemplateId] = useState('');
          const [purchaseDate, setPurchaseDate] = useState(new Date().toISOString().split('T')[0]);
          const [isSaving, setIsSaving] = useState(false);
          const [error, setError] = useState('');

          const handleSubmit = async (e) => {
              e.preventDefault();
              if (!templateId || !purchaseDate) {
                  setError('Please select a ticket pack and a purchase date.');
                  return;
              }
              setIsSaving(true);
              setError('');

              try {
                  await onSave(client.id, templateId, new Date(purchaseDate));
                  onClose(); // Call onClose on success
              } catch (err) {
                  console.error("Failed to save purchase from modal:", err);
                  setError(err.message || 'An unexpected error occurred. Please try again.');
              } finally {
                  setIsSaving(false);
              }
          };

          return (
              <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-xl shadow-xl p-8 w-full max-w-md">
                      <h2 className="text-2xl font-bold mb-6 text-primary-dark">{t('recordPurchaseFor', { clientName: `${client.firstName} ${client.lastName}` })}</h2>
                      <form onSubmit={handleSubmit} className="space-y-4">
                          <div>
                              <label htmlFor="ticket-pack" className="block text-sm font-medium text-slate-700">{t('ticketPack')}</label>
                              <select 
                                  id="ticket-pack"
                                  value={templateId} 
                                  onChange={e => setTemplateId(e.target.value)}
                                  required
                                  className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"
                              >
                                  <option value="">{t('selectAPack')}</option>
                                  {templates.filter(t => t.status === PackTemplateStatus.ACTIVE).map(t => (
                                      <option key={t.id} value={t.id}>{t.name}</option>
                                  ))}
                              </select>
                          </div>
                          <div>
                              <label htmlFor="purchase-date" className="block text-sm font-medium text-slate-700">{t('purchaseDate')}</label>
                              <input 
                                  type="date" 
                                  id="purchase-date"
                                  value={purchaseDate}
                                  onChange={e => setPurchaseDate(e.target.value)}
                                  required 
                                  className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                          </div>
                          
                          {error && (
                              <div className="bg-rose-100 border-l-4 border-rose-500 text-rose-700 p-3 my-4 rounded" role="alert">
                                  <p>{error}</p>
                              </div>
                          )}

                          <div className="flex justify-end space-x-4 pt-6">
                              <button type="button" onClick={onClose} disabled={isSaving} className="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 font-semibold disabled:opacity-50">{t('cancel')}</button>
                              <button type="submit" disabled={isSaving} className="px-4 py-2 bg-accent text-white rounded-md hover:bg-accent-dark font-semibold flex items-center justify-center w-24 disabled:bg-slate-400">
                                  {isSaving ? <LoaderCircle className="animate-spin h-5 w-5" /> : t('save')}
                              </button>
                          </div>
                      </form>
                  </div>
              </div>
          );
      };

      const HistoryModal = ({ pack, template, onClose }) => {
          const { t, formatDate, formatCurrency } = useLanguage();
          const [isCopied, setIsCopied] = useState(false);
          
          if (!pack || !template) return null;

          const purchaseEvent = pack.history.find(h => h.type === PackHistoryType.PURCHASE);
          const otherEvents = pack.history
              .filter(h => h.type !== PackHistoryType.PURCHASE)
              .sort((a,b) => new Date(b.date) - new Date(a.date)); // Most recent first
          
          const handleCopy = async () => {
              const attendanceEvents = pack.history.filter(h => h.type === PackHistoryType.ATTENDANCE);
              const attendanceDates = attendanceEvents.length > 0
                  ? attendanceEvents.map(e => `- ${formatDate(e.date)}`).join('\n')
                  : t('packHistorySummaryNoAttendance');
              
              const textToCopy = [
                  t('packHistorySummaryTitle', { packName: template.name }),
                  '',
                  t('packHistorySummaryPurchase', { date: formatDate(pack.purchaseDate), price: formatCurrency(pack.purchasePrice) }),
                  t('packHistorySummaryExpiry', { date: formatDate(pack.expiryDate) }),
                  t('packHistorySummaryTickets', { remaining: pack.ticketsRemaining, initial: pack.initialTickets }),
                  '',
                  t('packHistorySummaryAttendanceHeader'),
                  attendanceDates
              ].join('\n');
              
              try {
                  await navigator.clipboard.writeText(textToCopy);
                  setIsCopied(true);
                  setTimeout(() => setIsCopied(false), 2000);
              } catch (err) {
                  console.error('Failed to copy text: ', err);
              }
          };

          const HistoryItem = ({ item }) => (
            <div className="flex items-start space-x-4 pb-4 border-b border-slate-200 last:border-b-0">
              <div className={`mt-1 rounded-full p-2 ${item.type === PackHistoryType.PURCHASE ? 'bg-emerald-100 text-emerald-600' : item.type === PackHistoryType.EXPIRY_CHANGE ? 'bg-amber-100 text-amber-600' : 'bg-sky-100 text-sky-600'}`}>
                {item.type === PackHistoryType.PURCHASE && <DollarSign size={16}/>}
                {item.type === PackHistoryType.ATTENDANCE && <Ticket size={16}/>}
                {item.type === PackHistoryType.EXPIRY_CHANGE && <Clock size={16}/>}
              </div>
              <div>
                 <p className="font-semibold text-primary-dark">{item.details}</p>
                 <p className="text-sm text-slate-500">{formatDate(item.date)}</p>
              </div>
            </div>
          );

          return (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-xl shadow-xl p-8 w-full max-w-lg flex flex-col">
                      <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-primary-dark">{template.name} - {t('viewHistory')}</h2>
                        <button onClick={onClose} className="text-slate-500 hover:text-slate-800"><X size={24}/></button>
                      </div>
                      
                      <div className="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                          <p className="text-sm text-slate-500 font-medium">{t('expires')}</p>
                          <p className="text-lg font-semibold text-primary-dark">{formatDate(pack.expiryDate)}</p>
                      </div>

                      <div className="space-y-4 max-h-[50vh] overflow-y-auto pr-2">
                          {purchaseEvent && <HistoryItem item={purchaseEvent} />}
                          
                          {otherEvents.map((item, index) => (
                            <HistoryItem key={index} item={item} />
                          ))}
                      </div>

                      <div className="mt-auto pt-6 border-t border-slate-200 text-right">
                          <button 
                            onClick={handleCopy}
                            className="inline-flex items-center justify-center px-4 py-2 bg-accent text-white rounded-md hover:bg-accent-dark font-semibold transition-all duration-200 ease-in-out w-40"
                          >
                            {isCopied ? t('copied') : (
                                <>
                                    <Clipboard size={16} className="mr-2" />
                                    {t('copyHistory')}
                                </>
                            )}
                          </button>
                      </div>
                  </div>
              </div>
          );
      };
      
      const ExpiryModal = ({ pack, onClose, onSave }) => {
        const { t, formatDate } = useLanguage();
        const [expiryDate, setExpiryDate] = useState(pack.expiryDate.split('T')[0]);

        const handleSubmit = (e) => {
            e.preventDefault();
            onSave(pack.id, new Date(expiryDate));
            onClose();
        };

        return (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-xl p-8 w-full max-w-md">
                    <h2 className="text-2xl font-bold mb-6 text-primary-dark">{t('pauseEditExpiry')}</h2>
                    <p className="mb-4 text-slate-600">Current expiry: {formatDate(pack.expiryDate)}</p>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                           <label htmlFor="expiry-date" className="block text-sm font-medium text-slate-700">New Expiry Date</label>
                           <input 
                              type="date"
                              id="expiry-date"
                              value={expiryDate}
                              onChange={e => setExpiryDate(e.target.value)}
                              required
                              className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"
                            />
                        </div>
                        <div className="flex justify-end space-x-4 pt-6">
                            <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 font-semibold">{t('cancel')}</button>
                            <button type="submit" className="px-4 py-2 bg-accent text-white rounded-md hover:bg-accent-dark font-semibold">{t('save')}</button>
                        </div>
                    </form>
                </div>
            </div>
        );
      };


      const ClientsScreen = ({ data, actions }) => {
          const { t, formatDate } = useLanguage();
          const { clients, packTemplates, purchasedPacks } = data;
          const { addClient, updateClient, recordPurchase, updatePurchasedPackExpiry } = actions;
          
          const [selectedClient, setSelectedClient] = useState(null);
          const [isClientFormOpen, setIsClientFormOpen] = useState(false);
          const [isPurchaseModalOpen, setIsPurchaseModalOpen] = useState(false);
          const [isHistoryModalOpen, setIsHistoryModalOpen] = useState(false);
          const [isExpiryModalOpen, setIsExpiryModalOpen] = useState(false);
          const [packForModal, setPackForModal] = useState(null);
          const [clientToEdit, setClientToEdit] = useState(null);

          const handleAddClient = (client) => {
              addClient(client);
              setIsClientFormOpen(false);
          };

          const handleUpdateClient = (client) => {
              updateClient(client);
              setIsClientFormOpen(false);
              setClientToEdit(null);
          };

          const handleToggleClientStatus = (client) => {
              const newStatus = client.status === ClientStatus.ACTIVE ? ClientStatus.INACTIVE : ClientStatus.ACTIVE;
              updateClient({ ...client, status: newStatus });
          };
          
          const handleUpdateExpiry = (packId, newDate) => {
              updatePurchasedPackExpiry(packId, newDate);
              setIsExpiryModalOpen(false);
          };

          const getPackStatus = (pack) => {
              if (new Date(pack.expiryDate) < new Date()) return { text: t('status_expired'), color: 'bg-rose-100 text-rose-800' };
              if (pack.ticketsRemaining === 0) return { text: t('status_used'), color: 'bg-slate-200 text-slate-800' };
              return { text: t('status_active'), color: 'bg-emerald-100 text-emerald-800' };
          };
          
          const clientDetailView = selectedClient && (
            <div>
              <button onClick={() => setSelectedClient(null)} className="flex items-center text-sm font-semibold text-slate-600 hover:text-primary-dark mb-6">
                {t('backToClientList')}
              </button>
              <div className="flex justify-between items-start mb-6">
                <div>
                  <h2 className="text-3xl font-bold text-primary-dark">{selectedClient.firstName} {selectedClient.lastName}</h2>
                  <p className="text-slate-500">{selectedClient.email} &bull; {selectedClient.phone}</p>
                </div>
                <div className="flex items-center space-x-2 flex-shrink-0">
                  <button 
                    onClick={() => { setClientToEdit(selectedClient); setIsClientFormOpen(true); }} 
                    className="flex items-center px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 font-semibold"
                    aria-label={t('editClient')}
                  >
                    <Edit size={16} className="mr-2" />
                    {t('editClient')}
                  </button>
                  <button 
                    onClick={() => setIsPurchaseModalOpen(true)} 
                    className="flex items-center px-4 py-2 bg-accent text-white rounded-md hover:bg-accent-dark font-semibold"
                  >
                    <PlusCircle size={16} className="mr-2" />
                    {t('recordPurchase')}
                  </button>
                </div>
              </div>

              <h3 className="text-xl font-semibold text-primary-dark mt-8 mb-4">{t('purchasedPacks')}</h3>
              <div className="space-y-4">
                {purchasedPacks.filter(p => p.clientId === selectedClient.id).length > 0 ? purchasedPacks.filter(p => p.clientId === selectedClient.id).map(p => {
                    const template = packTemplates.find(t => t.id === p.templateId);
                    if (!template) return null;
                    const status = getPackStatus(p);
                    return (
                        <div key={p.id} className="bg-white p-4 rounded-lg shadow-sm border border-slate-200/80">
                            <div className="flex justify-between items-start">
                                <div>
                                    <p className="font-bold text-primary-dark">{template.name}</p>
                                    <p className="text-sm text-slate-500">{t('purchaseDate')}: {formatDate(p.purchaseDate)}</p>
                                </div>
                                <span className={`text-xs font-bold px-2.5 py-1 rounded-full ${status.color}`}>{status.text}</span>
                            </div>
                            <div className="flex justify-between items-end mt-4">
                              <div>
                                  <p className="text-2xl font-bold text-accent">{p.ticketsRemaining}</p>
                                  <p className="text-sm text-slate-500">{t('ticketsRemaining')}</p>
                              </div>
                              <div className="text-right">
                                  <p className="text-sm text-slate-500">{t('expires')}: {formatDate(p.expiryDate)}</p>
                                  <div className="space-x-2 mt-1">
                                    <button onClick={() => { setPackForModal(p); setIsHistoryModalOpen(true); }} className="px-3 py-1 text-xs font-semibold text-slate-600 bg-slate-200 rounded-md hover:bg-slate-300">{t('viewHistory')}</button>
                                    <button onClick={() => { setPackForModal(p); setIsExpiryModalOpen(true); }} className="px-3 py-1 text-xs font-semibold text-slate-600 bg-slate-200 rounded-md hover:bg-slate-300">{t('pauseEditExpiry')}</button>
                                  </div>
                              </div>
                            </div>
                        </div>
                    );
                }) : <p className="text-slate-500">{t('noPacksPurchased')}</p>}
              </div>
            </div>
          );

          const clientListView = (
            <div>
              <div className="flex justify-between items-center mb-8">
                <h2 className="text-3xl font-bold text-primary-dark">{t('clients')}</h2>
                <button onClick={() => { setClientToEdit(null); setIsClientFormOpen(true); }} className="flex items-center px-4 py-2 bg-accent text-white rounded-md hover:bg-accent-dark font-semibold">
                    <PlusCircle size={18} className="mr-2" /> {t('addClient')}
                </button>
              </div>
              <div className="bg-white rounded-xl shadow-sm border border-slate-200/80 overflow-hidden">
                <table className="w-full text-left">
                  <thead className="bg-slate-50 border-b border-slate-200 text-sm text-slate-500">
                      <tr>
                          <th className="p-4">Name</th>
                          <th className="p-4">Contact</th>
                          <th className="p-4">Status</th>
                      </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-200">
                      {clients.map(client => (
                          <tr key={client.id} onClick={() => setSelectedClient(client)} className="hover:bg-slate-50 cursor-pointer">
                              <td className="p-4 font-semibold text-primary-dark">{client.firstName} {client.lastName}</td>
                              <td className="p-4 text-slate-600">{client.email}</td>
                              <td className="p-4">
                                  <span className={`px-2 py-0.5 text-xs font-medium rounded-full ${client.status === ClientStatus.ACTIVE ? 'bg-emerald-100 text-emerald-800' : 'bg-slate-200 text-slate-800'}`}>
                                      {t(client.status)}
                                  </span>
                              </td>
                          </tr>
                      ))}
                  </tbody>
                </table>
              </div>
            </div>
          );

          return (
            <div>
              {selectedClient ? clientDetailView : clientListView}

              {isClientFormOpen && (
                <ClientFormModal 
                  client={clientToEdit}
                  onSave={clientToEdit ? handleUpdateClient : handleAddClient}
                  onClose={() => setIsClientFormOpen(false)}
                  onToggleStatus={handleToggleClientStatus}
                />
              )}
              {isPurchaseModalOpen && selectedClient && (
                <PurchaseModal 
                  client={selectedClient} 
                  templates={packTemplates} 
                  onSave={recordPurchase} 
                  onClose={() => setIsPurchaseModalOpen(false)}
                />
              )}
              {isHistoryModalOpen && packForModal && (
                <HistoryModal
                  pack={packForModal}
                  template={packTemplates.find(t => t.id === packForModal.templateId)}
                  onClose={() => setIsHistoryModalOpen(false)}
                />
              )}
              {isExpiryModalOpen && packForModal && (
                <ExpiryModal
                  pack={packForModal}
                  onSave={handleUpdateExpiry}
                  onClose={() => setIsExpiryModalOpen(false)}
                />
              )}
            </div>
          );
      };

      const TemplateFormModal = ({ template, onSave, onClose }) => {
          const { t } = useLanguage();
          const [formData, setFormData] = useState({
              name: template?.name || '',
              ticketCount: template?.ticketCount || '',
              ticketType: template?.ticketType || TicketType.GROUP,
              price: template?.price || '',
              expiryMonths: template?.expiryMonths || '',
          });

          const handleChange = (e) => {
              const { name, value, type } = e.target;
              setFormData(prev => ({ ...prev, [name]: type === 'number' ? Number(value) : value }));
          };

          const handleSubmit = (e) => {
              e.preventDefault();
              if (template) {
                onSave({ ...template, ...formData });
              } else {
                onSave({ ...formData, status: PackTemplateStatus.ACTIVE });
              }
          };

          return (
              <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-xl shadow-xl p-8 w-full max-w-md">
                      <h2 className="text-2xl font-bold mb-6 text-primary-dark">{template ? t('editTemplate') : t('addNewTemplate')}</h2>
                      <form onSubmit={handleSubmit} className="space-y-4">
                          <div>
                              <label htmlFor="packName" className="block text-sm font-medium text-slate-700">{t('packName')}</label>
                              <input type="text" name="name" value={formData.name} onChange={handleChange} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                              <div>
                                  <label htmlFor="numTickets" className="block text-sm font-medium text-slate-700">{t('numTickets')}</label>
                                  <input type="number" name="ticketCount" min="1" value={formData.ticketCount} onChange={handleChange} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                              </div>
                              <div>
                                  <label htmlFor="ticketType" className="block text-sm font-medium text-slate-700">{t('ticketType')}</label>
                                  <select name="ticketType" value={formData.ticketType} onChange={handleChange} className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent">
                                      <option value={TicketType.GROUP}>{t('group')}</option>
                                      <option value={TicketType.PRIVATE}>{t('private')}</option>
                                  </select>
                              </div>
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                              <div>
                                  <label htmlFor="price" className="block text-sm font-medium text-slate-700">{t('price')}</label>
                                  <input type="number" name="price" min="0" value={formData.price} onChange={handleChange} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                              </div>
                              <div>
                                  <label htmlFor="expiryMonths" className="block text-sm font-medium text-slate-700">{t('expiryMonths')}</label>
                                  <input type="number" name="expiryMonths" min="1" value={formData.expiryMonths} onChange={handleChange} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                              </div>
                          </div>
                          <div className="flex justify-end space-x-4 pt-6">
                              <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 font-semibold">{t('cancel')}</button>
                              <button type="submit" className="px-4 py-2 bg-accent text-white rounded-md hover:bg-accent-dark font-semibold">{t('saveTemplate')}</button>
                          </div>
                      </form>
                  </div>
              </div>
          );
      };

      const TemplatesScreen = ({ data, actions }) => {
          const { t, formatCurrency } = useLanguage();
          const { packTemplates } = data;
          const { addPackTemplate, updatePackTemplate } = actions;
          
          const [isFormOpen, setIsFormOpen] = useState(false);
          const [templateToEdit, setTemplateToEdit] = useState(null);

          const handleSave = (template) => {
              if (template.id) {
                  updatePackTemplate(template);
              } else {
                  addPackTemplate(template);
              }
              setIsFormOpen(false);
              setTemplateToEdit(null);
          };

          const handleToggleStatus = (template) => {
              const newStatus = template.status === PackTemplateStatus.ACTIVE ? PackTemplateStatus.INACTIVE : PackTemplateStatus.ACTIVE;
              updatePackTemplate({ ...template, status: newStatus });
          };

          return (
              <div>
                  <div className="flex justify-between items-center mb-8">
                      <h2 className="text-3xl font-bold text-primary-dark">{t('packTemplates')}</h2>
                      <button onClick={() => { setTemplateToEdit(null); setIsFormOpen(true); }} className="flex items-center px-4 py-2 bg-accent text-white rounded-md hover:bg-accent-dark font-semibold">
                          <PlusCircle size={18} className="mr-2" /> {t('addTemplate')}
                      </button>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      {packTemplates.map(template => (
                          <div key={template.id} className="bg-white p-6 rounded-xl shadow-sm border border-slate-200/80 flex flex-col justify-between">
                              <div>
                                  <div className="flex justify-between items-start">
                                      <h3 className="text-xl font-bold text-primary-dark">{template.name}</h3>
                                      <span className={`px-2 py-0.5 text-xs font-medium rounded-full ${template.status === PackTemplateStatus.ACTIVE ? 'bg-emerald-100 text-emerald-800' : 'bg-slate-200 text-slate-800'}`}>
                                          {t(template.status)}
                                      </span>
                                  </div>
                                  <p className="text-slate-500 mt-2">{t('templateDetails', {
                                      count: template.ticketCount,
                                      type: t(template.ticketType),
                                      price: formatCurrency(template.price),
                                      months: template.expiryMonths
                                  })}</p>
                              </div>
                              <div className="flex justify-end space-x-2 mt-6">
                                  <button onClick={() => { setTemplateToEdit(template); setIsFormOpen(true); }} className="p-2 bg-slate-200 text-slate-700 rounded-full hover:bg-slate-300"><Edit size={16}/></button>
                                  <button onClick={() => handleToggleStatus(template)} className="px-3 py-1 text-sm font-semibold rounded-md transition-colors text-white bg-primary hover:bg-primary-dark">
                                      {template.status === PackTemplateStatus.ACTIVE ? t('deactivate') : t('activate')}
                                  </button>
                              </div>
                          </div>
                      ))}
                  </div>

                  {isFormOpen && (
                      <TemplateFormModal
                          template={templateToEdit}
                          onSave={handleSave}
                          onClose={() => { setIsFormOpen(false); setTemplateToEdit(null); }}
                      />
                  )}
              </div>
          );
      };

      const AttendanceScreen = ({ data, actions }) => {
          const { t, formatDate } = useLanguage();
          const { clients, packTemplates, purchasedPacks, attendanceRecords } = data;
          const { recordAttendance, deleteAttendance } = actions;
          
          const [classDate, setClassDate] = useState(new Date());
          const [classType, setClassType] = useState(TicketType.GROUP);
          const [selectedClientIds, setSelectedClientIds] = useState([]);
          const [searchTerm, setSearchTerm] = useState('');

          const eligibleClients = useMemo(() => {
              return clients
                  .filter(c => c.status === ClientStatus.ACTIVE)
                  .filter(c => {
                      const hasValidPack = purchasedPacks.some(p => {
                          const template = packTemplates.find(t => t.id === p.templateId);
                          return p.clientId === c.id &&
                                 template?.ticketType === classType &&
                                 p.ticketsRemaining > 0 &&
                                 new Date(p.expiryDate) >= classDate;
                      });
                      return hasValidPack;
                  });
          }, [clients, purchasedPacks, packTemplates, classDate, classType]);

          const filteredClients = useMemo(() => {
              if (!searchTerm) return eligibleClients;
              return eligibleClients.filter(c => 
                  `${c.firstName} ${c.lastName}`.toLowerCase().includes(searchTerm.toLowerCase())
              );
          }, [searchTerm, eligibleClients]);

          const handleToggleClient = (clientId) => {
              setSelectedClientIds(prev =>
                  prev.includes(clientId)
                      ? prev.filter(id => id !== clientId)
                      : [...prev, clientId]
              );
          };

          const handleRecordAttendance = () => {
              if (selectedClientIds.length > 0) {
                  recordAttendance(classDate, classType, selectedClientIds);
                  setSelectedClientIds([]);
                  setSearchTerm('');
              }
          };

          const handleDeleteAttendance = (recordId) => {
              if (window.confirm(t('deleteAttendanceConfirm'))) {
                  deleteAttendance(recordId);
              }
          };
          
          const sortedAttendanceRecords = useMemo(() => {
              return [...attendanceRecords].sort((a,b) => new Date(b.classDate) - new Date(a.classDate));
          }, [attendanceRecords]);

          return (
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                  <div className="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-slate-200/80 h-fit">
                      <h2 className="text-2xl font-bold text-primary-dark mb-6">{t('recordAttendance')}</h2>
                      <div className="space-y-4">
                          <div>
                              <label htmlFor="classDate" className="block text-sm font-medium text-slate-700">{t('classDate')}</label>
                              <input type="date" id="classDate" value={classDate.toISOString().split('T')[0]} onChange={e => setClassDate(new Date(e.target.value))} className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                          </div>
                          <div>
                              <label htmlFor="classType" className="block text-sm font-medium text-slate-700">{t('classType')}</label>
                              <select id="classType" value={classType} onChange={e => setClassType(e.target.value)} className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent">
                                  <option value={TicketType.GROUP}>{t('group')}</option>
                                  <option value={TicketType.PRIVATE}>{t('private')}</option>
                              </select>
                          </div>
                          <div>
                              <label className="block text-sm font-medium text-slate-700">{t('attendees')}</label>
                              <input type="text" placeholder={t('searchAttendees')} value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                              <div className="mt-2 border border-slate-300 rounded-md max-h-60 overflow-y-auto">
                                  {filteredClients.length > 0 ? filteredClients.map(client => (
                                      <div key={client.id} className="flex items-center p-3 border-b border-slate-200 last:border-b-0">
                                          <input 
                                              type="checkbox" 
                                              id={`client-${client.id}`}
                                              checked={selectedClientIds.includes(client.id)}
                                              onChange={() => handleToggleClient(client.id)}
                                              className="h-4 w-4 text-accent border-slate-300 rounded focus:ring-accent"
                                          />
                                          <label htmlFor={`client-${client.id}`} className="ml-3 block text-sm text-slate-800">{client.firstName} {client.lastName}</label>
                                      </div>
                                  )) : <p className="p-3 text-sm text-slate-500">{t('noMatchingClients')}</p>}
                              </div>
                          </div>
                          <button onClick={handleRecordAttendance} disabled={selectedClientIds.length === 0} className="w-full px-4 py-2 bg-accent text-white rounded-md hover:bg-accent-dark font-semibold disabled:bg-slate-400 disabled:cursor-not-allowed">
                              {t('recordAttendanceCount', { count: selectedClientIds.length })}
                          </button>
                      </div>
                  </div>
                  <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-200/80">
                      <h2 className="text-2xl font-bold text-primary-dark mb-6">{t('attendanceHistory')}</h2>
                      <div className="overflow-x-auto">
                        <table className="w-full text-left">
                            <thead className="bg-slate-50 border-b border-slate-200 text-sm text-slate-500">
                                <tr>
                                    <th className="p-4">{t('historyDate')}</th>
                                    <th className="p-4">{t('historyClient')}</th>
                                    <th className="p-4">{t('historyClassType')}</th>
                                    <th className="p-4">{t('historyActions')}</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-200">
                                {sortedAttendanceRecords.length > 0 ? sortedAttendanceRecords.map(record => {
                                    const client = clients.find(c => c.id === record.clientId);
                                    return (
                                        <tr key={record.id}>
                                            <td className="p-4 text-slate-600">{formatDate(record.classDate)}</td>
                                            <td className="p-4 font-semibold text-primary-dark">{client ? `${client.firstName} ${client.lastName}` : 'Unknown Client'}</td>
                                            <td className="p-4 text-slate-600">{t(record.classType)}</td>
                                            <td className="p-4">
                                                <button onClick={() => handleDeleteAttendance(record.id)} className="text-rose-600 hover:text-rose-800">
                                                    <Trash2 size={18}/>
                                                </button>
                                            </td>
                                        </tr>
                                    );
                                }) : (
                                    <tr>
                                        <td colSpan="4" className="text-center p-8 text-slate-500">{t('noAttendanceRecords')}</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                      </div>
                  </div>
              </div>
          );
      };


      // --- Authentication and App Shell ---
      const LoginScreen = () => {
          const { t } = useLanguage();
          const [isSignUp, setIsSignUp] = useState(false);
          const [email, setEmail] = useState('');
          const [password, setPassword] = useState('');
          const [error, setError] = useState('');

          const handleGoogleSignIn = async () => {
              const provider = new GoogleAuthProvider();
              try {
                  await signInWithPopup(auth, provider);
              } catch (err) {
                  setError(err.message);
              }
          };

          const handleEmailAuth = async (e) => {
              e.preventDefault();
              setError('');
              try {
                  if (isSignUp) {
                      await createUserWithEmailAndPassword(auth, email, password);
                  } else {
                      await signInWithEmailAndPassword(auth, email, password);
                  }
              } catch (err) {
                  setError(err.message);
              }
          };

          return (
              <div className="min-h-screen bg-secondary flex items-center justify-center p-4">
                  <div className="absolute top-4 right-4">
                    <LanguageSwitcher />
                  </div>
                  <div className="w-full max-w-sm">
                      <div className="text-center mb-8">
                          <h1 className="text-3xl font-bold text-primary-dark">Lesson Navi</h1>
                          <p className="text-slate-500 mt-2">{isSignUp ? t('createAccountPrompt') : t('signInPrompt')}</p>
                      </div>

                      <div className="bg-white p-8 rounded-xl shadow-md border border-slate-200/80">
                          <form onSubmit={handleEmailAuth} className="space-y-6">
                              <div>
                                  <label htmlFor="email" className="block text-sm font-medium text-slate-700">{t('emailLabel')}</label>
                                  <input id="email" name="email" type="email" value={email} onChange={e => setEmail(e.target.value)} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                              </div>
                              <div>
                                  <label htmlFor="password" className="block text-sm font-medium text-slate-700">{t('passwordLabel')}</label>
                                  <input id="password" name="password" type="password" value={password} onChange={e => setPassword(e.target.value)} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                              </div>
                              {error && <p className="text-sm text-red-600">{error}</p>}
                              <div>
                                  <button type="submit" className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-accent hover:bg-accent-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent">
                                      {isSignUp ? t('signUpButton') : t('signInButton')}
                                  </button>
                              </div>
                          </form>
                          
                          <div className="mt-6">
                              <div className="relative">
                                  <div className="absolute inset-0 flex items-center">
                                      <div className="w-full border-t border-slate-300" />
                                  </div>
                                  <div className="relative flex justify-center text-sm">
                                      <span className="px-2 bg-white text-slate-500">{t('orSeparator')}</span>
                                  </div>
                              </div>

                              <div className="mt-6">
                                  <button onClick={handleGoogleSignIn} className="w-full inline-flex justify-center py-2 px-4 border border-slate-300 rounded-md shadow-sm bg-white text-sm font-medium text-slate-500 hover:bg-slate-50">
                                      <img className="w-5 h-5" src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google logo"/>
                                      <span className="ml-3">{t('googleSignInButton')}</span>
                                  </button>
                              </div>
                          </div>
                      </div>
                      <p className="mt-8 text-center text-sm text-slate-600">
                          {isSignUp ? t('alreadyHaveAccount') : t('dontHaveAccount')}{' '}
                          <button onClick={() => setIsSignUp(!isSignUp)} className="font-medium text-accent hover:text-accent-dark">
                              {isSignUp ? t('signInButton') : t('signUpButton')}
                          </button>
                      </p>
                  </div>
              </div>
          );
      };

      const App = () => {
          const { t } = useLanguage();
          const [user, setUser] = useState(null);
          const [authLoading, setAuthLoading] = useState(true);
          const [page, setPage] = useState(Page.DASHBOARD);

          const firestoreData = useFirestoreData(user?.uid);

          useEffect(() => {
              const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                  setUser(currentUser);
                  setAuthLoading(false);
              });
              return () => unsubscribe();
          }, []);

          const handleSignOut = async () => {
            if (window.confirm(t('signOutConfirm'))) {
              await signOut(auth);
            }
          }

          if (authLoading || (user && firestoreData.loading)) {
              return (
                  <div className="min-h-screen flex items-center justify-center bg-secondary">
                      <LoaderCircle className="h-12 w-12 text-accent animate-spin" />
                  </div>
              );
          }

          if (!user) {
              return <LoginScreen />;
          }

          const NavLink = ({ children, icon: Icon, pageName }) => (
            <button 
              onClick={() => setPage(pageName)}
              className={`flex items-center w-full px-4 py-3 rounded-lg font-semibold transition-colors ${
                page === pageName 
                  ? 'bg-accent text-white shadow-md' 
                  : 'text-slate-600 hover:bg-slate-200'
              }`}
            >
              <Icon size={20} className="mr-3" />
              {children}
            </button>
          );

          return (
              <div className="flex min-h-screen">
                  <aside className="w-64 bg-white border-r border-slate-200 p-4 flex flex-col">
                      <div className="text-2xl font-bold text-primary-dark mb-10 pl-2">Lesson Navi</div>
                      <nav className="flex-grow space-y-2">
                          <NavLink pageName={Page.DASHBOARD} icon={LayoutDashboard}>{t('dashboard')}</NavLink>
                          <NavLink pageName={Page.CLIENTS} icon={Users}>{t('clients')}</NavLink>
                          <NavLink pageName={Page.TEMPLATES} icon={ClipboardList}>{t('packTemplates')}</NavLink>
                          <NavLink pageName={Page.ATTENDANCE} icon={Calendar}>{t('attendance')}</NavLink>
                      </nav>
                      <div className="space-y-2">
                        <LanguageSwitcher className="w-full" />
                        <button onClick={handleSignOut} className="w-full flex items-center px-4 py-3 text-slate-600 hover:bg-slate-200 rounded-lg font-semibold">
                          <LogOut size={20} className="mr-3"/> {t('signOut')}
                        </button>
                      </div>
                  </aside>
                  <main className="flex-1 p-8 lg:p-12 bg-secondary">
                      {page === Page.DASHBOARD && <DashboardScreen data={firestoreData} />}
                      {page === Page.CLIENTS && <ClientsScreen data={firestoreData} actions={{...firestoreData}} />}
                      {page === Page.TEMPLATES && <TemplatesScreen data={firestoreData} actions={{...firestoreData}}/>}
                      {page === Page.ATTENDANCE && <AttendanceScreen data={firestoreData} actions={{...firestoreData}} />}
                  </main>
              </div>
          );
      };

      const Root = () => (
        <LanguageProvider>
          <App />
        </LanguageProvider>
      );
      
      createRoot(document.getElementById('root')).render(<Root />);

    </script>
  </body>
</html>