<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TicketTrack Pilates</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#334155', // slate-700
              'primary-dark': '#1e293b', // slate-800
              secondary: '#f1f5f9', // slate-100
              accent: '#6366f1', // indigo-500
              'accent-dark': '#4f46e5', // indigo-600
            },
          },
        },
      }
    </script>
    <!-- Add Babel Standalone for in-browser JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-secondary">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      import React, { useState, useMemo, useEffect, useCallback } from 'https://esm.sh/react@^19.1.1';
      import { createRoot } from 'https://esm.sh/react-dom@^19.1.1/client';
      import { 
        Calendar, Users, ClipboardList, LayoutDashboard, 
        DollarSign, Ticket, Clock, AlertTriangle,
        PlusCircle, Edit, History, LogOut,
        Trash2, X, LoaderCircle
      } from 'https://esm.sh/lucide-react@^0.539.0';
      
      // --- Firebase SDKs ---
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
      import { 
        getAuth, 
        onAuthStateChanged,
        GoogleAuthProvider,
        signInWithPopup,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut
      } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
      import { 
        getFirestore, 
        collection, 
        onSnapshot, 
        addDoc, 
        updateDoc, 
        doc, 
        deleteDoc,
        Timestamp,
        query,
        where
      } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';


      // --- PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE ---
      // This is the object you copied from the Firebase console.
      const firebaseConfig = {
        apiKey: "AIzaSyD556mSEm-Q7IAIykHGXjhWc-kpgcmMpF0",
        authDomain: "ticket-tora.firebaseapp.com",
        projectId: "ticket-tora",
        storageBucket: "ticket-tora.firebasestorage.app",
        messagingSenderId: "194518083030",
        appId: "1:194518083030:web:b4b21f2786275e76deb077"
      };
      
      // --- Initialize Firebase ---
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- Enums and Constants (from types.js) ---
      const ClientStatus = Object.freeze({ ACTIVE: 'active', INACTIVE: 'inactive' });
      const TicketType = Object.freeze({ PRIVATE: 'private', GROUP: 'group' });
      const PackTemplateStatus = Object.freeze({ ACTIVE: 'active', INACTIVE: 'inactive' });
      const PackHistoryType = Object.freeze({ PURCHASE: 'purchase', ATTENDANCE: 'attendance', EXPIRY_CHANGE: 'expiry_change' });
      const Page = Object.freeze({ DASHBOARD: 'dashboard', CLIENTS: 'clients', TEMPLATES: 'templates', ATTENDANCE: 'attendance' });

      // --- Data Hook (Re-written for Firebase) ---
      const useFirestoreData = (userId) => {
          const [clients, setClients] = useState([]);
          const [packTemplates, setPackTemplates] = useState([]);
          const [purchasedPacks, setPurchasedPacks] = useState([]);
          const [attendanceRecords, setAttendanceRecords] = useState([]);
          const [loading, setLoading] = useState(true);

          useEffect(() => {
              if (!userId) {
                  setLoading(false);
                  return;
              };

              const collections = {
                  clients: collection(db, 'users', userId, 'clients'),
                  packTemplates: collection(db, 'users', userId, 'packTemplates'),
                  purchasedPacks: collection(db, 'users', userId, 'purchasedPacks'),
                  attendanceRecords: collection(db, 'users', userId, 'attendanceRecords'),
              };

              const unsubscribes = [
                  onSnapshot(collections.clients, snapshot => {
                      setClients(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                  }),
                  onSnapshot(collections.packTemplates, snapshot => {
                      setPackTemplates(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                  }),
                  onSnapshot(collections.purchasedPacks, snapshot => {
                      setPurchasedPacks(snapshot.docs.map(doc => {
                          const data = doc.data();
                          // Convert Firestore Timestamps back to JS Dates
                          return {
                              id: doc.id,
                              ...data,
                              purchaseDate: data.purchaseDate?.toDate().toISOString(),
                              expiryDate: data.expiryDate?.toDate().toISOString(),
                              history: data.history.map(h => ({...h, date: h.date?.toDate().toISOString()}))
                          };
                      }));
                  }),
                  onSnapshot(collections.attendanceRecords, snapshot => {
                      setAttendanceRecords(snapshot.docs.map(doc => {
                           const data = doc.data();
                           return { id: doc.id, ...data, classDate: data.classDate?.toDate().toISOString() };
                      }));
                  }),
              ];
              
              setLoading(false); // Consider more granular loading later

              // Cleanup listeners on unmount
              return () => unsubscribes.forEach(unsub => unsub());
          }, [userId]);

          // --- Data Modification Functions (now write to Firestore) ---

          const addClient = (client) => addDoc(collection(db, 'users', userId, 'clients'), client);
          const updateClient = (updatedClient) => {
              const { id, ...data } = updatedClient;
              updateDoc(doc(db, 'users', userId, 'clients', id), data);
          };

          const addPackTemplate = (template) => addDoc(collection(db, 'users', userId, 'packTemplates'), template);
          
          const updatePackTemplate = async (updatedTemplate) => {
              if (updatedTemplate.status === PackTemplateStatus.INACTIVE) {
                  const activePacksQuery = query(
                    collection(db, 'users', userId, 'purchasedPacks'),
                    where('templateId', '==', updatedTemplate.id)
                  );
                  // This is a simplified check. A full check would also verify ticket counts and expiry dates.
                  // For a client-side app, this alert is a reasonable guardrail.
                  const hasActivePacks = purchasedPacks.some(p => 
                      p.templateId === updatedTemplate.id &&
                      p.ticketsRemaining > 0 &&
                      new Date(p.expiryDate) > new Date()
                  );

                  if (hasActivePacks) {
                      alert('Cannot make template inactive as there are active client packs using it.');
                      return;
                  }
              }
              const { id, ...data } = updatedTemplate;
              updateDoc(doc(db, 'users', userId, 'packTemplates', id), data);
          };
          
          const recordPurchase = (clientId, templateId, purchaseDate) => {
              const template = packTemplates.find(t => t.id === templateId);
              if (!template) return;

              const expiryDate = new Date(purchaseDate);
              expiryDate.setMonth(expiryDate.getMonth() + template.expiryMonths);

              const newPack = {
                  clientId,
                  templateId,
                  purchaseDate: Timestamp.fromDate(purchaseDate),
                  expiryDate: Timestamp.fromDate(expiryDate),
                  initialTickets: template.ticketCount,
                  ticketsRemaining: template.ticketCount,
                  purchasePrice: template.price,
                  history: [
                      { date: Timestamp.fromDate(purchaseDate), type: PackHistoryType.PURCHASE, details: `Purchased pack for $${template.price.toFixed(2)}` }
                  ]
              };
              addDoc(collection(db, 'users', userId, 'purchasedPacks'), newPack);
          };

          const updatePurchasedPackExpiry = (packId, newExpiryDate) => {
              const packRef = doc(db, 'users', userId, 'purchasedPacks', packId);
              const pack = purchasedPacks.find(p => p.id === packId);
              if(!pack) return;

              const oldExpiryDate = new Date(pack.expiryDate).toLocaleDateString();
              const updatedHistory = {
                  date: Timestamp.now(),
                  type: PackHistoryType.EXPIRY_CHANGE,
                  details: `Expiry date changed from ${oldExpiryDate} to ${newExpiryDate.toLocaleDateString()}`
              };

              updateDoc(packRef, {
                  expiryDate: Timestamp.fromDate(newExpiryDate),
                  history: [...pack.history.map(h => ({...h, date: Timestamp.fromDate(new Date(h.date))})), updatedHistory]
              });
          };

          const recordAttendance = useCallback((classDate, classType, clientIds) => {
              clientIds.forEach(clientId => {
                  const clientPacks = purchasedPacks
                      .filter(p => {
                          const template = packTemplates.find(t => t.id === p.templateId);
                          return p.clientId === clientId &&
                                template?.ticketType === classType &&
                                p.ticketsRemaining > 0 &&
                                new Date(p.expiryDate) >= classDate;
                      })
                      .sort((a, b) => new Date(a.expiryDate).getTime() - new Date(b.expiryDate).getTime());

                  if (clientPacks.length > 0) {
                      const packToDeduct = clientPacks[0];
                      const packRef = doc(db, 'users', userId, 'purchasedPacks', packToDeduct.id);
                      
                      updateDoc(packRef, {
                          ticketsRemaining: packToDeduct.ticketsRemaining - 1,
                          history: [
                              ...packToDeduct.history.map(h => ({...h, date: Timestamp.fromDate(new Date(h.date))})),
                              {
                                date: Timestamp.fromDate(classDate),
                                type: PackHistoryType.ATTENDANCE,
                                details: `Attended ${classType} class`
                              }
                          ]
                      });
                      
                      addDoc(collection(db, 'users', userId, 'attendanceRecords'), {
                          classDate: Timestamp.fromDate(classDate),
                          classType,
                          clientId,
                          purchasedPackId: packToDeduct.id
                      });
                  }
              });
          }, [purchasedPacks, packTemplates, userId]);

          const deleteAttendance = useCallback(async (recordId) => {
              const recordToDelete = attendanceRecords.find(r => r.id === recordId);
              if (!recordToDelete) return;

              const packRef = doc(db, 'users', userId, 'purchasedPacks', recordToDelete.purchasedPackId);
              const pack = purchasedPacks.find(p => p.id === recordToDelete.purchasedPackId);

              if (pack) {
                  await updateDoc(packRef, {
                      ticketsRemaining: pack.ticketsRemaining + 1,
                      history: pack.history
                        .map(h => ({...h, date: Timestamp.fromDate(new Date(h.date))}))
                        .filter(h => h.type !== PackHistoryType.ATTENDANCE || h.date.toMillis() !== new Date(recordToDelete.classDate).getTime())
                  });
              }

              await deleteDoc(doc(db, 'users', userId, 'attendanceRecords', recordId));
          }, [attendanceRecords, purchasedPacks, userId]);
          
          return {
              loading,
              clients, addClient, updateClient,
              packTemplates, addPackTemplate, updatePackTemplate,
              purchasedPacks, recordPurchase, updatePurchasedPackExpiry,
              attendanceRecords, recordAttendance, deleteAttendance
          };
      };

      // --- Screens (largely unchanged, but now get data from Firestore hook) ---
      const StatCard = ({ icon, title, value, iconBg, iconColor }) => (
          <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200/80 flex items-center">
              <div className={`rounded-full p-3 mr-4 ${iconBg} ${iconColor}`}>
                  {icon}
              </div>
              <div>
                  <p className="text-sm text-slate-500 font-medium">{title}</p>
                  <p className="text-2xl font-bold text-primary-dark">{value}</p>
              </div>
          </div>
      );

      const DashboardScreen = ({ data }) => {
          const { clients, purchasedPacks, attendanceRecords, packTemplates } = data;

          const stats = useMemo(() => {
              const thirtyDaysAgo = new Date();
              thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

              const totalSales = purchasedPacks
                  .filter(p => new Date(p.purchaseDate) >= thirtyDaysAgo)
                  .reduce((sum, p) => sum + p.purchasePrice, 0);

              const totalTicketsUsed = attendanceRecords
                  .filter(a => new Date(a.classDate) >= thirtyDaysAgo)
                  .length;

              return { totalSales, totalTicketsUsed };
          }, [purchasedPacks, attendanceRecords]);

          const expiringPacks = useMemo(() => {
              const thirtyDaysFromNow = new Date();
              thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
              const today = new Date();

              return purchasedPacks
                  .filter(p => {
                      const expiryDate = new Date(p.expiryDate);
                      return expiryDate >= today && expiryDate <= thirtyDaysFromNow && p.ticketsRemaining > 0;
                  })
                  .sort((a, b) => new Date(a.expiryDate).getTime() - new Date(b.expiryDate).getTime())
                  .map(p => {
                      const client = clients.find(c => c.id === p.clientId);
                      const template = packTemplates.find(t => t.id === p.templateId);
                      return { ...p, client, template };
                  });
          }, [purchasedPacks, clients, packTemplates]);
          
          const lowBalanceClients = useMemo(() => {
              const today = new Date();
              return purchasedPacks
                  .filter(p => p.ticketsRemaining === 1 && new Date(p.expiryDate) >= today)
                  .map(p => {
                      const client = clients.find(c => c.id === p.clientId);
                      const template = packTemplates.find(t => t.id === p.templateId);
                      return { ...p, client, template };
                  });
          }, [purchasedPacks, clients, packTemplates]);

          return (
              <div className="space-y-8">
                  <h2 className="text-3xl font-bold text-primary-dark">Dashboard</h2>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <StatCard 
                          icon={<DollarSign className="h-6 w-6"/>} 
                          title="Total Sales (Last 30 Days)" 
                          value={`$${stats.totalSales.toFixed(2)}`}
                          iconBg="bg-emerald-100"
                          iconColor="text-emerald-600"
                      />
                      <StatCard 
                          icon={<Ticket className="h-6 w-6"/>} 
                          title="Tickets Used (Last 30 Days)" 
                          value={stats.totalTicketsUsed}
                          iconBg="bg-sky-100"
                          iconColor="text-sky-600"
                      />
                  </div>

                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200/80">
                          <h3 className="text-xl font-semibold text-primary-dark mb-4 flex items-center">
                              <Clock className="h-6 w-6 mr-3 text-accent" />
                              Packs Expiring in Next 30 Days
                          </h3>
                          <div className="space-y-0 max-h-96 overflow-y-auto">
                              {expiringPacks.length > 0 ? expiringPacks.map((p, index) => (
                                  <div key={p.id} className={`p-4 border-b border-slate-200 ${index === expiringPacks.length - 1 ? 'border-b-0' : ''}`}>
                                      <p className="font-semibold text-primary-dark">{p.client?.firstName} {p.client?.lastName}</p>
                                      <p className="text-sm text-slate-500">{p.template?.name}</p>
                                      <div className="flex justify-between items-baseline text-sm mt-1">
                                          <span className="font-medium text-slate-600">Tickets: {p.ticketsRemaining}</span>
                                          <span className="font-semibold text-amber-700">Expires: {new Date(p.expiryDate).toLocaleDateString()}</span>
                                      </div>
                                  </div>
                              )) : <p className="text-slate-500 p-4">No packs expiring soon.</p>}
                          </div>
                      </div>

                      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200/80">
                          <h3 className="text-xl font-semibold text-primary-dark mb-4 flex items-center">
                              <AlertTriangle className="h-6 w-6 mr-3 text-yellow-500" />
                              Critical Low Balance (1 Ticket Left)
                          </h3>
                          <div className="space-y-0 max-h-96 overflow-y-auto">
                              {lowBalanceClients.length > 0 ? lowBalanceClients.map((p, index) => (
                                  <div key={p.id} className={`p-4 border-b border-slate-200 ${index === lowBalanceClients.length - 1 ? 'border-b-0' : ''}`}>
                                      <p className="font-semibold text-primary-dark">{p.client?.firstName} {p.client?.lastName}</p>
                                      <p className="text-sm text-slate-500">{p.template?.name}</p>
                                  </div>
                              )) : <p className="text-slate-500 p-4">No clients with a critically low balance.</p>}
                          </div>
                      </div>
                  </div>
              </div>
          );
      };

      const ClientFormModal = ({ client, onSave, onClose, onToggleStatus }) => {
          const [formData, setFormData] = useState({
              firstName: client?.firstName || '',
              lastName: client?.lastName || '',
              email: client?.email || '',
              phone: client?.phone || '',
          });

          const handleChange = (e) => {
              const { name, value } = e.target;
              setFormData(prev => ({ ...prev, [name]: value }));
          };

          const handleSubmit = (e) => {
              e.preventDefault();
              if (client) {
                onSave({ ...client, ...formData });
              } else {
                onSave({ ...formData, status: ClientStatus.ACTIVE });
              }
          };
          
          return (
              <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-xl shadow-xl p-8 w-full max-w-md">
                      <h2 className="text-2xl font-bold mb-6 text-primary-dark">{client ? 'Edit Client' : 'Add New Client'}</h2>
                      <form onSubmit={handleSubmit} className="space-y-4">
                          <div>
                              <label htmlFor="firstName" className="block text-sm font-medium text-slate-700">First Name</label>
                              <input type="text" name="firstName" value={formData.firstName} onChange={handleChange} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                          </div>
                          <div>
                              <label htmlFor="lastName" className="block text-sm font-medium text-slate-700">Last Name</label>
                              <input type="text" name="lastName" value={formData.lastName} onChange={handleChange} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                          </div>
                          <div>
                              <label htmlFor="email" className="block text-sm font-medium text-slate-700">Email</label>
                              <input type="email" name="email" value={formData.email} onChange={handleChange} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                          </div>
                          <div>
                              <label htmlFor="phone" className="block text-sm font-medium text-slate-700">Phone</label>
                              <input type="tel" name="phone" value={formData.phone} onChange={handleChange} className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                          </div>
                          <div className="flex justify-between items-center pt-6">
                              <div>
                                  {client && (
                                      <button 
                                          type="button" 
                                          onClick={() => {
                                              onToggleStatus(client);
                                              onClose();
                                          }}
                                          className={`px-4 py-2 text-sm font-medium rounded-md transition-colors ${
                                              client.status === ClientStatus.ACTIVE
                                                  ? 'bg-rose-100 text-rose-800 hover:bg-rose-200'
                                                  : 'bg-emerald-100 text-emerald-800 hover:bg-emerald-200'
                                          }`}
                                      >
                                          {client.status === ClientStatus.ACTIVE ? 'Set to Inactive' : 'Set to Active'}
                                      </button>
                                  )}
                              </div>
                              <div className="flex justify-end space-x-4">
                                  <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 font-semibold">Cancel</button>
                                  <button type="submit" className="px-4 py-2 bg-primary-dark text-white rounded-md hover:bg-primary font-semibold">Save Client</button>
                              </div>
                          </div>
                      </form>
                  </div>
              </div>
          );
      };

      const PurchaseFormModal = ({ client, templates, onSave, onClose }) => {
          const [templateId, setTemplateId] = useState('');
          const [purchaseDate, setPurchaseDate] = useState(new Date().toISOString().split('T')[0]);

          const handleSubmit = (e) => {
              e.preventDefault();
              if (!templateId) {
                  alert('Please select a pack template.');
                  return;
              }
              onSave(client.id, templateId, new Date(purchaseDate));
          };

          return (
              <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-xl shadow-xl p-8 w-full max-w-md">
                      <h2 className="text-2xl font-bold mb-6 text-primary-dark">Record Purchase for {client.firstName}</h2>
                      <form onSubmit={handleSubmit} className="space-y-4">
                          <div>
                              <label htmlFor="templateId" className="block text-sm font-medium text-slate-700">Ticket Pack</label>
                              <select name="templateId" value={templateId} onChange={e => setTemplateId(e.target.value)} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent">
                                  <option value="">Select a pack</option>
                                  {templates.filter(t => t.status === 'active').map(t => (
                                      <option key={t.id} value={t.id}>{t.name} - ${t.price}</option>
                                  ))}
                              </select>
                          </div>
                          <div>
                              <label htmlFor="purchaseDate" className="block text-sm font-medium text-slate-700">Purchase Date</label>
                              <input type="date" name="purchaseDate" value={purchaseDate} onChange={e => setPurchaseDate(e.target.value)} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                          </div>
                          <div className="flex justify-end space-x-4 pt-6">
                              <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 font-semibold">Cancel</button>
                              <button type="submit" className="px-4 py-2 bg-accent text-white rounded-md hover:bg-accent-dark font-semibold">Record Purchase</button>
                          </div>
                      </form>
                  </div>
              </div>
          );
      };

      const ClientDetailView = ({ client, packs, templates, onBack, onRecordPurchase, onUpdateExpiry }) => {
          const [purchasing, setPurchasing] = useState(false);
          const [editingExpiryPackId, setEditingExpiryPackId] = useState(null);
          const [newExpiryDate, setNewExpiryDate] = useState('');

          const handleEditExpiry = (pack) => {
              setEditingExpiryPackId(pack.id);
              setNewExpiryDate(new Date(pack.expiryDate).toISOString().split('T')[0]);
          };
          
          const handleSaveExpiry = () => {
              if (editingExpiryPackId && newExpiryDate) {
                  onUpdateExpiry(editingExpiryPackId, new Date(newExpiryDate));
                  setEditingExpiryPackId(null);
              }
          };

          return (
              <div className="bg-white p-6 sm:p-8 rounded-xl shadow-sm border border-slate-200/80">
                  <button onClick={onBack} className="mb-6 text-accent hover:underline font-semibold">← Back to Client List</button>
                  <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                      <div className="mb-4 sm:mb-0">
                          <h2 className="text-3xl font-bold text-primary-dark">{client.firstName} {client.lastName}</h2>
                          <p className="text-slate-500">{client.email} | {client.phone}</p>
                      </div>
                      <button onClick={() => setPurchasing(true)} className="flex items-center px-4 py-2 bg-accent text-white rounded-md hover:bg-accent-dark font-semibold">
                          <PlusCircle className="h-5 w-5 mr-2" />
                          Record Purchase
                      </button>
                  </div>
                  <div className="mt-8">
                      <h3 className="text-xl font-semibold text-primary-dark mb-4">Purchased Packs</h3>
                      <div className="space-y-4">
                          {packs.length > 0 ? packs.map(pack => {
                              const getPackStatus = (p) => {
                                  const today = new Date();
                                  today.setHours(0, 0, 0, 0);
                                  if (new Date(p.expiryDate) < today) {
                                      return { text: 'Expired', color: 'bg-slate-200 text-slate-800' };
                                  }
                                  if (p.ticketsRemaining <= 0) {
                                      return { text: 'Used', color: 'bg-amber-100 text-amber-800' };
                                  }
                                  return { text: 'Active', color: 'bg-emerald-100 text-emerald-800' };
                              };
                              const status = getPackStatus(pack);

                              return (
                                  <div key={pack.id} className="bg-slate-50 p-5 rounded-xl border border-slate-200">
                                      <div className="flex justify-between items-start">
                                          <div>
                                              <p className="font-bold text-lg text-primary-dark">{pack.template?.name}</p>
                                              <p className="text-sm text-slate-500 capitalize">{pack.template?.ticketType} Tickets</p>
                                          </div>
                                          <span className={`px-2 py-1 text-xs font-semibold rounded-full ${status.color}`}>
                                              {status.text}
                                          </span>
                                      </div>

                                      <div className="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm">
                                          <div>
                                              <p className="text-slate-500">Purchased</p>
                                              <p className="font-semibold text-primary-dark">{new Date(pack.purchaseDate).toLocaleDateString()}</p>
                                          </div>
                                          <div>
                                              <p className="text-slate-500">Expires</p>
                                              <p className="font-semibold text-primary-dark">{new Date(pack.expiryDate).toLocaleDateString()}</p>
                                          </div>
                                          <div className="col-span-2 sm:col-span-1">
                                              <div className="flex justify-between items-baseline">
                                                  <span className="text-slate-500">Tickets Remaining</span>
                                                  <span className="font-semibold text-primary-dark text-lg">{pack.ticketsRemaining} / {pack.initialTickets}</span>
                                              </div>
                                              <div className="w-full bg-slate-200 rounded-full h-2.5 mt-1">
                                                  <div
                                                      className="bg-accent h-2.5 rounded-full transition-all duration-500"
                                                      style={{ width: `${pack.initialTickets > 0 ? (pack.ticketsRemaining / pack.initialTickets) * 100 : 0}%` }}
                                                  ></div>
                                              </div>
                                          </div>
                                      </div>

                                      <div className="mt-4 pt-4 border-t border-slate-200">
                                          <div className="flex justify-between items-center">
                                              <details>
                                                  <summary className="cursor-pointer text-accent font-medium flex items-center text-sm">
                                                      <History className="h-4 w-4 mr-2"/>
                                                      View History
                                                  </summary>
                                                  <ul className="mt-2 space-y-1 text-sm text-slate-600 pl-6 list-disc">
                                                      {pack.history.sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime()).map(log => (
                                                          <li key={log.id}>
                                                              <strong>{new Date(log.date).toLocaleDateString()}:</strong> {log.details}
                                                          </li>
                                                      ))}
                                                  </ul>
                                              </details>
                                              
                                              <div>
                                                  {editingExpiryPackId === pack.id ? (
                                                      <div className="flex justify-end items-center space-x-2">
                                                          <input type="date" value={newExpiryDate} onChange={e => setNewExpiryDate(e.target.value)} className="border-slate-300 rounded-md shadow-sm text-sm p-1" />
                                                          <button onClick={handleSaveExpiry} className="px-3 py-1 bg-primary-dark text-white text-xs rounded-md font-semibold">Save</button>
                                                          <button onClick={() => setEditingExpiryPackId(null)} className="px-3 py-1 bg-slate-200 text-xs rounded-md font-semibold">Cancel</button>
                                                      </div>
                                                  ) : (
                                                      <button onClick={() => handleEditExpiry(pack)} className="flex items-center text-sm text-accent hover:underline font-semibold">
                                                          <Edit className="h-4 w-4 mr-1"/> Pause/Edit Expiry
                                                      </button>
                                                  )}
                                              </div>
                                          </div>
                                      </div>
                                  </div>
                              );
                          }) : <p className="text-slate-500">No packs purchased yet.</p>}
                      </div>
                  </div>
                  {purchasing && <PurchaseFormModal client={client} templates={templates} onClose={() => setPurchasing(false)} onSave={(...args) => { onRecordPurchase(...args); setPurchasing(false); }} />}
              </div>
          );
      }

      const ClientsScreen = ({ data }) => {
          const { clients, updateClient, addClient, purchasedPacks, packTemplates, recordPurchase, updatePurchasedPackExpiry } = data;
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [editingClient, setEditingClient] = useState(null);
          const [selectedClient, setSelectedClient] = useState(null);

          const handleSaveClient = (clientData) => {
              if (editingClient) {
                  updateClient(clientData);
              } else {
                  addClient(clientData);
              }
              setIsModalOpen(false);
              setEditingClient(null);
          };
          
          const handleToggleStatus = (client) => {
              const newStatus = client.status === ClientStatus.ACTIVE ? ClientStatus.INACTIVE : ClientStatus.ACTIVE;
              updateClient({ ...client, status: newStatus });
          };

          if (selectedClient) {
              const clientPacks = purchasedPacks
                  .filter(p => p.clientId === selectedClient.id)
                  .map(p => ({ ...p, template: packTemplates.find(t => t.id === p.templateId) }))
                  .sort((a,b) => new Date(b.purchaseDate).getTime() - new Date(a.purchaseDate).getTime());
              
              return <ClientDetailView 
                  client={selectedClient} 
                  packs={clientPacks}
                  templates={packTemplates}
                  onBack={() => setSelectedClient(null)}
                  onRecordPurchase={recordPurchase}
                  onUpdateExpiry={updatePurchasedPackExpiry}
              />;
          }

          return (
              <div className="space-y-6">
                  <div className="flex justify-between items-center">
                      <h2 className="text-3xl font-bold text-primary-dark">Clients</h2>
                      <button onClick={() => { setEditingClient(null); setIsModalOpen(true); }} className="flex items-center px-4 py-2 bg-primary-dark text-white rounded-md shadow-sm hover:bg-primary font-semibold">
                          <PlusCircle className="h-5 w-5 mr-2" />
                          Add Client
                      </button>
                  </div>

                  <div className="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200/80">
                      <ul className="divide-y divide-slate-200">
                          {clients.sort((a,b) => a.lastName.localeCompare(b.lastName)).map(client => {
                              const today = new Date();
                              today.setHours(0, 0, 0, 0);

                              const activePacks = purchasedPacks.filter(p => 
                                  p.clientId === client.id &&
                                  p.ticketsRemaining > 0 &&
                                  new Date(p.expiryDate) >= today
                              );
              
                              const totalTicketsRemaining = activePacks.reduce((sum, p) => sum + p.ticketsRemaining, 0);
                              const totalInitialTickets = activePacks.reduce((sum, p) => sum + p.initialTickets, 0);

                              return (
                                  <li key={client.id} className={`p-4 sm:p-5 hover:bg-slate-50/50 transition-colors duration-200 ${client.status === ClientStatus.INACTIVE ? 'opacity-60' : ''}`}>
                                      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between">
                                          <div className="mb-2 sm:mb-0">
                                              <button onClick={() => setSelectedClient(client)} className="text-lg font-semibold text-primary-dark hover:text-accent text-left">
                                                  {client.firstName} {client.lastName}
                                              </button>
                                              <p className="text-sm text-slate-500">{client.email}</p>
                                          </div>
                                          <div className="flex items-center space-x-4">
                                              {totalInitialTickets > 0 && (
                                                  <span className="text-sm text-slate-600 font-medium">
                                                      {totalTicketsRemaining}/{totalInitialTickets} Tickets
                                                  </span>
                                              )}
                                              <span className={`px-2 py-1 text-xs font-semibold rounded-full ${client.status === ClientStatus.ACTIVE ? 'bg-emerald-100 text-emerald-800' : 'bg-rose-100 text-rose-800'}`}>
                                                  {client.status}
                                              </span>
                                              <button onClick={() => { setEditingClient(client); setIsModalOpen(true); }} className="p-2 text-slate-400 hover:text-primary-dark hover:bg-slate-100 rounded-md"><Edit className="h-5 w-5"/></button>
                                          </div>
                                      </div>
                                  </li>
                              );
                          })}
                      </ul>
                  </div>
                  
                  {isModalOpen && <ClientFormModal client={editingClient} onClose={() => setIsModalOpen(false)} onSave={handleSaveClient} onToggleStatus={handleToggleStatus} />}
              </div>
          );
      };

      const TemplateFormModal = ({ template, onSave, onClose }) => {
          const [formData, setFormData] = useState({
              name: template?.name || '',
              ticketCount: template?.ticketCount || 10,
              ticketType: template?.ticketType || TicketType.GROUP,
              price: template?.price || 0,
              expiryMonths: template?.expiryMonths || 1,
          });

          const handleChange = (e) => {
              const { name, value, type } = e.target;
              const isNumber = type === 'number';
              setFormData(prev => ({ ...prev, [name]: isNumber ? Number(value) : value }));
          };

          const handleSubmit = (e) => {
              e.preventDefault();
              if (template) {
                onSave({ ...template, ...formData });
              } else {
                onSave({ ...formData, status: PackTemplateStatus.ACTIVE });
              }
          };
          
          return (
              <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-xl shadow-xl p-8 w-full max-w-md">
                      <h2 className="text-2xl font-bold mb-6 text-primary-dark">{template ? 'Edit Template' : 'Add New Template'}</h2>
                      <form onSubmit={handleSubmit} className="space-y-4">
                          <div>
                              <label className="block text-sm font-medium text-slate-700">Pack Name</label>
                              <input type="text" name="name" value={formData.name} onChange={handleChange} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                              <div>
                                  <label className="block text-sm font-medium text-slate-700">Number of Tickets</label>
                                  <input type="number" name="ticketCount" value={formData.ticketCount} onChange={handleChange} required min="1" className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                              </div>
                              <div>
                                  <label className="block text-sm font-medium text-slate-700">Ticket Type</label>
                                  <select name="ticketType" value={formData.ticketType} onChange={handleChange} className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent">
                                      <option value={TicketType.GROUP}>Group</option>
                                      <option value={TicketType.PRIVATE}>Private</option>
                                  </select>
                              </div>
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                              <div>
                                  <label className="block text-sm font-medium text-slate-700">Price ($)</label>
                                  <input type="number" name="price" value={formData.price} onChange={handleChange} required min="0" step="0.01" className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                              </div>
                              <div>
                                  <label className="block text-sm font-medium text-slate-700">Expiry (Months)</label>
                                  <input type="number" name="expiryMonths" value={formData.expiryMonths} onChange={handleChange} required min="1" className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                              </div>
                          </div>
                          <div className="flex justify-end space-x-4 pt-6">
                              <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 font-semibold">Cancel</button>
                              <button type="submit" className="px-4 py-2 bg-primary-dark text-white rounded-md hover:bg-primary font-semibold">Save Template</button>
                          </div>
                      </form>
                  </div>
              </div>
          );
      };

      const TemplatesScreen = ({ data }) => {
          const { packTemplates, addPackTemplate, updatePackTemplate } = data;
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [editingTemplate, setEditingTemplate] = useState(null);

          const handleSaveTemplate = (templateData) => {
              if (editingTemplate) {
                  updatePackTemplate(templateData);
              } else {
                  addPackTemplate(templateData);
              }
              setIsModalOpen(false);
              setEditingTemplate(null);
          };

          const handleToggleStatus = (template) => {
              const newStatus = template.status === PackTemplateStatus.ACTIVE ? PackTemplateStatus.INACTIVE : PackTemplateStatus.ACTIVE;
              updatePackTemplate({ ...template, status: newStatus });
          };

          return (
              <div className="space-y-6">
                  <div className="flex justify-between items-center">
                      <h2 className="text-3xl font-bold text-primary-dark">Ticket Pack Templates</h2>
                      <button onClick={() => { setEditingTemplate(null); setIsModalOpen(true); }} className="flex items-center px-4 py-2 bg-primary-dark text-white rounded-md shadow-sm hover:bg-primary font-semibold">
                          <PlusCircle className="h-5 w-5 mr-2" />
                          Add Template
                      </button>
                  </div>

                  <div className="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200/80">
                      <ul className="divide-y divide-slate-200">
                          {packTemplates.sort((a,b) => a.name.localeCompare(b.name)).map(template => (
                              <li key={template.id} className={`p-4 sm:p-5 hover:bg-slate-50/50 transition-colors duration-200 ${template.status === PackTemplateStatus.INACTIVE ? 'opacity-60' : ''}`}>
                                  <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between">
                                      <div className="mb-2 sm:mb-0">
                                          <p className="text-lg font-semibold text-primary-dark">{template.name}</p>
                                          <p className="text-sm text-slate-500">
                                              {template.ticketCount} {template.ticketType} tickets for ${template.price} (Expires in {template.expiryMonths} months)
                                          </p>
                                      </div>
                                      <div className="flex items-center space-x-4">
                                          <span className={`px-2 py-1 text-xs font-semibold rounded-full ${template.status === PackTemplateStatus.ACTIVE ? 'bg-emerald-100 text-emerald-800' : 'bg-rose-100 text-rose-800'}`}>
                                              {template.status}
                                          </span>
                                          <button 
                                              onClick={() => handleToggleStatus(template)} 
                                              className="px-3 py-1.5 text-xs font-semibold text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-full"
                                              title={template.status === PackTemplateStatus.ACTIVE ? 'Set to Inactive' : 'Set to Active'}
                                          >
                                              {template.status === PackTemplateStatus.ACTIVE ? 'Deactivate' : 'Activate'}
                                          </button>
                                          <button onClick={() => { setEditingTemplate(template); setIsModalOpen(true); }} className="p-2 text-slate-400 hover:text-primary-dark hover:bg-slate-100 rounded-md"><Edit className="h-5 w-5"/></button>
                                      </div>
                                  </div>
                              </li>
                          ))}
                      </ul>
                  </div>
                  
                  {isModalOpen && <TemplateFormModal template={editingTemplate} onClose={() => setIsModalOpen(false)} onSave={handleSaveTemplate} />}
              </div>
          );
      };

      const AttendanceScreen = ({ data }) => {
          const { clients, purchasedPacks, packTemplates, attendanceRecords, recordAttendance, deleteAttendance } = data;
          const [classDate, setClassDate] = useState(new Date().toISOString().split('T')[0]);
          const [classType, setClassType] = useState(TicketType.GROUP);
          const [selectedClients, setSelectedClients] = useState(new Set());
          const [searchTerm, setSearchTerm] = useState('');

          const eligibleClients = useMemo(() => {
              const date = new Date(classDate);
              return clients.filter(client => {
                  if (client.status !== ClientStatus.ACTIVE) return false;
                  
                  return purchasedPacks.some(pack => {
                      const template = packTemplates.find(t => t.id === pack.templateId);
                      return pack.clientId === client.id &&
                            template?.ticketType === classType &&
                            pack.ticketsRemaining > 0 &&
                            new Date(pack.expiryDate) >= date;
                  });
              });
          }, [classDate, classType, clients, purchasedPacks, packTemplates]);
          
          const addSelectedClient = (clientId) => {
              setSelectedClients(prev => new Set(prev).add(clientId));
              setSearchTerm('');
          };

          const removeSelectedClient = (clientId) => {
              setSelectedClients(prev => {
                  const newSet = new Set(prev);
                  newSet.delete(clientId);
                  return newSet;
              });
          };
          
          const searchResults = useMemo(() => {
              if (!searchTerm.trim()) return [];
              
              return eligibleClients.filter(client => 
                  !selectedClients.has(client.id) &&
                  `${client.firstName} ${client.lastName}`.toLowerCase().includes(searchTerm.toLowerCase())
              );
          }, [searchTerm, eligibleClients, selectedClients]);

          const selectedClientObjects = useMemo(() => {
              return clients.filter(c => selectedClients.has(c.id))
                  .sort((a,b) => a.lastName.localeCompare(b.lastName));
          }, [selectedClients, clients]);

          const handleSubmit = (e) => {
              e.preventDefault();
              if (selectedClients.size === 0) {
                  alert('Please select at least one client.');
                  return;
              }
              recordAttendance(new Date(classDate), classType, Array.from(selectedClients));
              setSelectedClients(new Set());
          };
          
          const handleDelete = (recordId) => {
              if (window.confirm('Are you sure you want to delete this attendance record? This will restore the ticket to the client.')) {
                  deleteAttendance(recordId);
              }
          };

          const recordsWithClientInfo = useMemo(() => {
              return attendanceRecords
                  .map(record => ({
                      ...record,
                      client: clients.find(c => c.id === record.clientId)
                  }))
                  .sort((a,b) => new Date(b.classDate).getTime() - new Date(a.classDate).getTime());
          }, [attendanceRecords, clients]);

          return (
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                  <div className="lg:col-span-1">
                      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200/80 sticky top-28">
                          <h2 className="text-2xl font-bold text-primary-dark mb-6">Record Attendance</h2>
                          <form onSubmit={handleSubmit} className="space-y-4">
                              <div>
                                  <label className="block text-sm font-medium text-slate-700">Class Date</label>
                                  <input type="date" value={classDate} onChange={e => setClassDate(e.target.value)} required className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent"/>
                              </div>
                              <div>
                                  <label className="block text-sm font-medium text-slate-700">Class Type</label>
                                  <select value={classType} onChange={e => { setClassType(e.target.value); setSelectedClients(new Set()); }} className="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-accent focus:border-accent">
                                      <option value={TicketType.GROUP}>Group</option>
                                      <option value={TicketType.PRIVATE}>Private</option>
                                  </select>
                              </div>
                              <div>
                                  <label htmlFor="attendee-search" className="block text-sm font-medium text-slate-700">Attendees</label>
                                  <div className="mt-1 relative">
                                      <div className="w-full p-2 border border-slate-300 rounded-md flex flex-wrap gap-2 min-h-[42px] items-center focus-within:ring-2 focus-within:ring-accent focus-within:border-accent">
                                          {selectedClientObjects.map(client => (
                                              <span key={client.id} className="bg-primary-dark text-white flex items-center gap-2 px-2.5 py-1 text-sm rounded-full">
                                                  {client.firstName} {client.lastName}
                                                  <button type="button" onClick={() => removeSelectedClient(client.id)} className="rounded-full hover:bg-primary transition-colors">
                                                      <X size={14} />
                                                  </button>
                                              </span>
                                          ))}
                                          <input
                                              id="attendee-search"
                                              type="text"
                                              value={searchTerm}
                                              onChange={e => setSearchTerm(e.target.value)}
                                              placeholder={selectedClients.size === 0 ? "Search for attendees..." : ""}
                                              className="flex-grow bg-transparent border-none focus:ring-0 p-0 text-sm"
                                          />
                                      </div>
                                      {searchTerm.trim() && (
                                          <div className="absolute z-10 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-xl">
                                              <ul className="max-h-60 overflow-y-auto">
                                                  {searchResults.length > 0 ? searchResults.map(client => (
                                                      <li 
                                                          key={client.id} 
                                                          className="p-2 px-3 hover:bg-slate-100 cursor-pointer text-sm"
                                                          onMouseDown={(e) => { 
                                                              e.preventDefault();
                                                              addSelectedClient(client.id);
                                                          }}
                                                      >
                                                          {client.firstName} {client.lastName}
                                                      </li>
                                                  )) : (
                                                      <li className="p-2 px-3 text-sm text-slate-500">No matching eligible clients found.</li>
                                                  )}
                                              </ul>
                                          </div>
                                      )}
                                  </div>
                              </div>
                              <button type="submit" className="w-full mt-6 px-4 py-2 bg-accent text-white rounded-md hover:bg-accent-dark font-semibold">
                                Record Attendance ({selectedClients.size})
                              </button>
                          </form>
                      </div>
                  </div>

                  <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-200/80">
                      <h2 className="text-2xl font-bold text-primary-dark mb-6">Attendance History</h2>
                      <div className="overflow-x-auto">
                          <table className="min-w-full">
                              <thead className="bg-slate-50">
                                  <tr>
                                      <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Date</th>
                                      <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Client</th>
                                      <th className="p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Class Type</th>
                                      <th className="p-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th>
                                  </tr>
                              </thead>
                              <tbody className="bg-white">
                                  {recordsWithClientInfo.map(record => (
                                      <tr key={record.id} className="border-b border-slate-200">
                                          <td className="p-4 whitespace-nowrap text-sm text-slate-800">{new Date(record.classDate).toLocaleDateString()}</td>
                                          <td className="p-4 whitespace-nowrap text-sm text-slate-800 font-medium">{record.client?.firstName} {record.client?.lastName}</td>
                                          <td className="p-4 whitespace-nowrap text-sm text-slate-500 capitalize">{record.classType}</td>
                                          <td className="p-4 whitespace-nowrap text-right text-sm font-medium">
                                              <button onClick={() => handleDelete(record.id)} className="text-slate-400 hover:text-red-500 p-1">
                                                  <Trash2 className="h-5 w-5"/>
                                              </button>
                                          </td>
                                      </tr>
                                  ))}
                              </tbody>
                          </table>
                      </div>
                      {recordsWithClientInfo.length === 0 && <p className="text-center text-slate-500 py-8">No attendance records found.</p>}
                  </div>
              </div>
          );
      };

      // --- New Login Screen ---
      const LoginScreen = () => {
          const [email, setEmail] = useState('');
          const [password, setPassword] = useState('');
          const [isSignUp, setIsSignUp] = useState(false);
          const [error, setError] = useState('');
          const [loading, setLoading] = useState(false);

          const handleAuthAction = async (e) => {
              e.preventDefault();
              setError('');
              setLoading(true);
              try {
                  if (isSignUp) {
                      await createUserWithEmailAndPassword(auth, email, password);
                  } else {
                      await signInWithEmailAndPassword(auth, email, password);
                  }
              } catch (err) {
                  setError(err.message);
              } finally {
                setLoading(false);
              }
          };

          const handleGoogleSignIn = async () => {
              setError('');
              setLoading(true);
              try {
                  const provider = new GoogleAuthProvider();
                  await signInWithPopup(auth, provider);
              } catch (err) {
                  setError(err.message);
              } finally {
                setLoading(false);
              }
          };

          return (
              <div className="flex items-center justify-center min-h-screen">
                  <div className="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg border border-slate-200/80">
                      <div>
                          <h1 className="text-3xl font-bold text-center text-primary-dark">TicketTrack Pilates</h1>
                          <p className="text-center text-slate-500 mt-2">{isSignUp ? 'Create an account to get started' : 'Sign in to your account'}</p>
                      </div>
                      <form className="space-y-4" onSubmit={handleAuthAction}>
                          <input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="Email address" required className="w-full px-4 py-2 border border-slate-300 rounded-md focus:ring-accent focus:border-accent" />
                          <input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="Password" required minLength="6" className="w-full px-4 py-2 border border-slate-300 rounded-md focus:ring-accent focus:border-accent" />
                          <button type="submit" disabled={loading} className="w-full px-4 py-2 font-semibold text-white bg-primary-dark rounded-md hover:bg-primary disabled:bg-slate-400 flex items-center justify-center">
                            {loading && <LoaderCircle className="animate-spin mr-2 h-5 w-5"/>}
                            {isSignUp ? 'Sign Up' : 'Sign In'}
                          </button>
                      </form>
                      {error && <p className="text-sm text-center text-red-600 bg-red-100 p-3 rounded-md">{error}</p>}
                      <div className="relative flex items-center">
                        <div className="flex-grow border-t border-slate-200"></div>
                        <span className="flex-shrink mx-4 text-slate-400 text-sm">OR</span>
                        <div className="flex-grow border-t border-slate-200"></div>
                      </div>
                      <button onClick={handleGoogleSignIn} disabled={loading} className="w-full flex items-center justify-center px-4 py-2 border border-slate-300 rounded-md hover:bg-slate-50 disabled:bg-slate-200">
                          <svg className="w-5 h-5 mr-2" viewBox="0 0 48 48">
                              <path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z" />
                              <path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z" />
                              <path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.519-3.483-11.083-8.194l-6.522 5.025C9.505 39.556 16.227 44 24 44z" />
                              <path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C44.471 36.053 48 30.637 48 24c0-1.341-.138-2.65-.389-3.917z" />
                          </svg>
                          Sign in with Google
                      </button>
                      <p className="text-center text-sm text-slate-600">
                          {isSignUp ? 'Already have an account? ' : "Don't have an account? "}
                          <button onClick={() => setIsSignUp(!isSignUp)} className="font-semibold text-accent hover:underline">
                              {isSignUp ? 'Sign In' : 'Sign Up'}
                          </button>
                      </p>
                  </div>
              </div>
          );
      };

      // --- Main Application Component ---
      const MainApp = ({ user }) => {
        const data = useFirestoreData(user.uid);
        const [currentPage, setCurrentPage] = useState(Page.DASHBOARD);
        
        const handleSignOut = () => {
          if (confirm('Are you sure you want to sign out?')) {
            signOut(auth);
          }
        };

        const renderPage = () => {
          if (data.loading) {
            return (
              <div className="flex justify-center items-center h-64">
                <LoaderCircle className="animate-spin h-10 w-10 text-accent"/>
              </div>
            );
          }
          switch (currentPage) {
            case Page.DASHBOARD: return <DashboardScreen data={data} />;
            case Page.CLIENTS: return <ClientsScreen data={data} />;
            case Page.TEMPLATES: return <TemplatesScreen data={data} />;
            case Page.ATTENDANCE: return <AttendanceScreen data={data} />;
            default: return <DashboardScreen data={data} />;
          }
        };

        const navItems = useMemo(() => [
          { page: Page.DASHBOARD, label: 'Dashboard', icon: LayoutDashboard },
          { page: Page.CLIENTS, label: 'Clients', icon: Users },
          { page: Page.TEMPLATES, label: 'Pack Templates', icon: ClipboardList },
          { page: Page.ATTENDANCE, label: 'Attendance', icon: Calendar },
        ], []);

        return (
          <div className="min-h-screen bg-secondary font-sans text-primary-dark">
            <header className="bg-white/80 backdrop-blur-lg sticky top-0 z-40 border-b border-slate-200">
              <div className="container mx-auto px-4 sm:px-6 lg:px-8">
                <div className="flex flex-col sm:flex-row items-center justify-between h-auto sm:h-20 py-4 sm:py-0">
                  <h1 className="text-2xl sm:text-3xl font-bold tracking-tight text-primary-dark mb-4 sm:mb-0">
                    TicketTrack Pilates
                  </h1>
                  <nav>
                    <ul className="flex flex-wrap justify-center items-center space-x-1 sm:space-x-2">
                      {navItems.map(item => (
                        <li key={item.page}>
                          <button
                            onClick={() => setCurrentPage(item.page)}
                            className={`flex items-center px-4 py-2 rounded-full text-sm font-semibold transition-colors duration-200 ${
                              currentPage === item.page
                                ? 'bg-accent/10 text-accent'
                                : 'text-slate-600 hover:bg-slate-200/60 hover:text-primary-dark'
                            }`}
                            aria-current={currentPage === item.page ? 'page' : undefined}
                          >
                            <item.icon className="mr-2 h-5 w-5" />
                            {item.label}
                          </button>
                        </li>
                      ))}
                      <li>
                        <button onClick={handleSignOut} title="Sign Out" className="flex items-center px-3 py-2 rounded-full text-sm font-semibold text-slate-600 hover:bg-rose-100 hover:text-rose-700 transition-colors">
                            <LogOut className="h-5 w-5" />
                        </button>
                      </li>
                    </ul>
                  </nav>
                </div>
              </div>
            </header>
            <main className="container mx-auto p-4 sm:p-6 lg:p-8">
              {renderPage()}
            </main>
          </div>
        );
      };

      // --- Root Application Component with Auth Logic ---
      const App = () => {
        const [user, setUser] = useState(null);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
          const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
            setUser(currentUser);
            setLoading(false);
          });
          // Cleanup subscription on unmount
          return () => unsubscribe();
        }, []);

        if (loading) {
          return (
            <div className="flex items-center justify-center min-h-screen">
              <LoaderCircle className="animate-spin h-12 w-12 text-accent" />
            </div>
          );
        }

        if (!user) {
          return <LoginScreen />;
        }

        return <MainApp user={user} />;
      }


      // --- Final Render Logic ---
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>